<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agency Portal</title>
  <style>
  :root{--bg:#212121;--panel:#2f2f2f;--muted:#9ca3af;--accent:#22d3ee;--ok:#10b981;--err:#ef4444;--warn:#f59e0b;--headerH:56px}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#212121;color:#ececec}
    header{position:sticky;top:0;z-index:10;display:flex;gap:16px;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid #2a2a2a;background:rgba(47,47,47,.95);backdrop-filter:blur(6px)}
    header .brand{font-weight:600;letter-spacing:.2px;color:#ececec}
    header .user{font-size:14px;color:#9ca3af}
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  /* Homepage (logged-out) full-screen layout */
  body.home-active{ background:
      radial-gradient(1200px 600px at -10% -10%, rgba(15,23,42,.6), transparent),
      radial-gradient(1200px 600px at 110% -10%, rgba(2,6,23,.6), transparent),
      linear-gradient(180deg, #0a1428 0%, #0b1324 40%, #0f172a 100%);
    }
  body.home-active .sidebar{ display:none !important; }
  body.home-active.has-sidebar{ padding-left:0 !important; }
  body.home-active header .user{ display:none; }
  body.home-active .tabs{ display:none !important; }
  body.home-active header{ border-bottom-color: transparent; background: linear-gradient(180deg, rgba(15,23,42,.85), rgba(2,6,23,.6)); box-shadow: none; }
  body.home-active .wrap{ max-width:1180px; padding:0 22px 50px; }
  #dashboard.homepage{ padding:0; background:transparent; border:none; margin:0; }
  .home-hero{ min-height:calc(100dvh - var(--headerH)); display:grid; grid-template-columns: 1.15fr 0.85fr; gap:28px; align-items:center; }
  @media(max-width:980px){ .home-hero{ grid-template-columns:1fr; padding:24px 0 10px; } }
  .home-copy h1{ font-size:44px; line-height:1.1; margin:0 0 12px; letter-spacing:.2px; }
  @media(max-width:720px){ .home-copy h1{ font-size:34px; } }
  .home-copy h1 .accent{ color: var(--accent); }
  .home-copy h1 .accent{ background: linear-gradient(90deg, #22d3ee, #60a5fa); -webkit-background-clip:text; background-clip:text; color:transparent; }
  .home-copy p.lead{ color:#cbd5e1; font-size:18px; margin:0 0 18px; }
  .pill{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:rgba(34,211,238,.12); color:#a5f3fc; border:1px solid rgba(34,211,238,.25); font-size:12px; font-weight:600; }
  .benefits{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin:18px 0 6px; }
  @media(max-width:720px){ .benefits{ grid-template-columns:1fr; } }
  .benefit{ background:#1b2337; border:1px solid #2b3b55; border-radius:12px; padding:12px; }
  .benefit h4{ margin:0 0 4px; font-size:14px; color:#e5e7eb }
  .benefit p{ margin:0; font-size:13px; color:#9ca3af }
  .features{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px; }
  @media(max-width:720px){ .features{ grid-template-columns:1fr; } }
  .feature{ background:#0b1324; border:1px solid #1f2a44; border-radius:12px; padding:12px; }
  .feature h5{ margin:0 0 6px; font-size:13px; color:#cbd5e1; letter-spacing:.2px }
  .langs{ font-size:11px; color:#93c5fd; opacity:.9; }
  .home-card{ background:#0a1428; border:1px solid #1f2a44; border-radius:14px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.25); }
  .home-side{ display:flex; flex-direction:column; gap:12px; }
  .home-auth .grid2{ grid-template-columns:1fr 1fr; }
  .home-auth label{ font-size:12px; color:#9ca3af; display:block; margin:4px 0; }
  .home-auth input{ background:#0b1020; border:1px solid #223150; }
  .home-auth .primary{ width:100%; padding:12px 14px; font-weight:700; }
  .divider{ height:1px; background:linear-gradient(90deg, transparent, #1f2a44, transparent); margin:4px 0; }
  .trust{ display:flex; gap:14px; flex-wrap:wrap; color:#9ca3af; font-size:12px; }
  .tag{ border:1px solid #374151; border-radius:999px; padding:4px 8px; background:#111827; color:#9ca3af; font-size:11px; transition:all .15s }
  .tag:hover{ border-color:#3b82f6; color:#c7d2fe }

  /* Footer */
  .site-footer{ margin-top:24px; padding:18px 0; border-top:1px solid #1f2a44; color:#9ca3af; font-size:12px }
  .site-footer .inner{ max-width:1180px; margin:0 auto; padding:0 22px; display:flex; gap:14px; align-items:center; justify-content:space-between; flex-wrap:wrap }
  .site-footer a{ color:#9ca3af; text-decoration:none; border-bottom:1px dotted transparent }
  .site-footer a:hover{ color:#cbd5e1; border-bottom-color:#334155 }

  /* Copilot full-screen layout */
  body.copilot-active header{ border-bottom-color: transparent; background: transparent; }
  body.copilot-active .wrap{ max-width:920px; padding-top:12px; }
  body.copilot-active .tabs{ display:none; }
  /* remove card feel for copilot container */
  .panel.copilot-root{ background:transparent; border:none; padding:0; margin:0; }
  .copilot-shell{ display:flex; flex-direction:column; gap:12px; min-height:calc(100dvh - var(--headerH)); }
  .copilot-chat{ display:flex; flex-direction:column; gap:10px; }
  .copilot-chat .chat-log{ max-height:none; min-height:55vh; padding:8px 0; }
  .copilot-chat .chat-input{ position:sticky; bottom:0; background:transparent; padding:8px 0; }
  .copilot-chat .chat-input input{ background:#1a1a1a; border:1px solid #404040; border-radius:20px; padding:12px 14px; }
  .copilot-chat .chat-input button{ border-radius:18px; }
  .tabs{display:flex;gap:10px;margin:10px 0 16px}
    .tab{padding:10px 14px;border-radius:8px;background:transparent;border:1px solid #404040;color:#9ca3af;cursor:pointer;transition:all 0.15s ease}
    .tab.active{background:#2f2f2f;border-color:#404040;color:#ececec}
    .tab:hover{background:#2a2a2a;border-color:#404040;color:#ececec}
    .panel{background:#2f2f2f;border:1px solid #404040;border-radius:12px;padding:16px;margin-bottom:16px}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .col{flex:1 1 340px}
    h2{margin:0 0 10px;font-size:18px;color:#ececec}
    h3{margin:0 0 8px;font-size:15px;color:#ececec}
    label{font-size:13px;color:#9ca3af}
    input,select,textarea{width:100%;background:#1a1a1a;color:#ececec;border:1px solid #404040;border-radius:8px;padding:10px 12px;transition:border-color 0.15s ease}
    input:focus,select:focus,textarea:focus{outline:none;border-color:#22d3ee}
    input::placeholder,textarea::placeholder{color:#6b7280}
    button{background:#2f2f2f;border:1px solid #404040;color:#ececec;border-radius:8px;padding:10px 14px;cursor:pointer;transition:all 0.15s ease}
    button:hover{background:#3a3a3a;border-color:#505050}
    button.primary{background:#22d3ee;color:#000;border:none;font-weight:600}
    button.primary:hover{background:#1fb5d3}
    .muted{color:#9ca3af}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{padding:2px 8px;border-radius:12px;font-size:12px;border:1px solid #404040;background:#2a2a2a;color:#ececec}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #404040;padding:8px;font-size:13px}
    th{color:#ececec;position:sticky;top:0;background:#2f2f2f;font-weight:600}
    td{color:#ececec}
    .status.ok{color:var(--ok)}.status.err{color:var(--err)}.status.upd{color:#60a5fa}
    .hint{font-size:12px;color:#9ca3af}
  .small{font-size:12px}
    .drop{border:1px dashed #404040;border-radius:12px;padding:16px;text-align:center;background:#2a2a2a;color:#9ca3af}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .badge{padding:2px 6px;border-radius:6px;font-size:11px;font-weight:600}
    .badge.success{background:#10b981;color:#fff}
    .badge.warning{background:#f59e0b;color:#fff}
    .badge.neutral{background:#6b7280;color:#fff}
    .btn-small{padding:4px 8px;font-size:11px;border-radius:6px}
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000}
    .modal-content{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#2f2f2f;border:1px solid #404040;border-radius:12px;padding:20px;max-width:600px;width:90%;max-height:80%;overflow-y:auto}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .modal-close{background:none;border:none;color:#9ca3af;font-size:20px;cursor:pointer}
    .llm-section{margin-bottom:16px;padding:12px;background:#2a2a2a;border-radius:8px}
    .llm-section h4{margin:0 0 8px;color:#ececec;font-size:14px}
    .llm-skills{display:flex;flex-wrap:wrap;gap:6px}
    .llm-skill{background:#404040;color:#ececec;padding:4px 8px;border-radius:6px;font-size:12px}
    .muted{color:#9ca3af;font-style:italic}
  /* Matches + Chat */
  .chat-box{display:flex;flex-direction:column;gap:8px;border:1px solid #404040;border-radius:12px;padding:12px;background:#2a2a2a}
  .chat-log{max-height:260px;overflow:auto;display:flex;flex-direction:column;gap:8px}
  .chat-msg{padding:8px 10px;border-radius:8px;font-size:13px;max-width:85%}
  /* Default chat (non-copilot) */
  .chat-msg.user{align-self:flex-start;background:#3a3a3a;border:1px solid #505050;color:#ececec}
  .chat-msg.bot{align-self:flex-end;background:#2f2f2f;border:1px solid #404040;color:#ececec}
  /* Copilot: mimic ChatGPT alignment (assistant left, user right) */
  body.copilot-active #copilot .chat-msg.bot{ align-self:flex-start; }
  body.copilot-active #copilot .chat-msg.user{ align-self:flex-end; }
  .chat-input{display:flex;gap:8px}
  .chat-input input{flex:1}
  .empty-state{padding:14px;border:1px dashed #404040;border-radius:12px;background:#2a2a2a;color:#9ca3af}
  /* Copilot: no visible frame around chat */
  body.copilot-active #copilot .chat-box{ border:none; background:transparent; padding:0; }
  /* Typing indicator (ChatGPT-like three dots) */
  .typing{ display:inline-flex; gap:4px; align-items:center; }
  .typing .dot{ width:6px; height:6px; border-radius:50%; background:#9ca3af; opacity:.6; animation: blink 1.2s infinite; }
  .typing .dot:nth-child(2){ animation-delay:.2s; }
  .typing .dot:nth-child(3){ animation-delay:.4s; }
  @keyframes blink{ 0%,80%,100%{ opacity:.3 } 40%{ opacity:1 } }
  .loading{opacity:.7}
  /* Score Explainer */
  .explain-card{background:#2a2a2a;border:1px solid #404040;border-radius:12px;padding:12px}
  .meter{height:8px;background:#1a1a1a;border:1px solid #404040;border-radius:999px;overflow:hidden}
  .meter>span{display:block;height:100%;background:#22d3ee}
  .grid-explain{display:grid;gap:10px}
  .grid-explain.cols-2{grid-template-columns:1fr 1fr}
  @media(max-width:720px){.grid-explain.cols-2{grid-template-columns:1fr}}
    @media(max-width:720px){.grid2{grid-template-columns:1fr}}

    /* Sidebar (ChatGPT-like) */
    body{ direction:ltr; }
    body.has-sidebar{ padding-left:280px; transition:padding-left .25s ease; }
    body.has-sidebar.sidebar-collapsed{ padding-left:60px; }
    .sidebar{ position:fixed; inset:0 auto 0 0; width:280px; background:#171717; border-right:1px solid #2a2a2a; z-index:20; display:flex; flex-direction:column; padding:8px; gap:4px; transition:width .25s ease; }
    .sidebar.collapsed{ width:60px; }
    .sidebar.collapsed .nav-item{ gap:0; justify-content:center; padding:12px 8px; }
    .sidebar .top{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 4px; margin-bottom:8px; }
    .sidebar .brand{ font-weight:600; color:#e2e8f0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:16px; }
    .sidebar.collapsed .brand{ display:none; }
    .nav{ list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:2px; }
  /* Hide specific items from the sidebar */
  .sidebar .nav .nav-item[data-tab="dashboard"],
  .sidebar .nav .nav-item[data-tab="upload"]{ display:none !important; }
    .nav-item{ display:flex; align-items:center; gap:12px; width:100%; background:transparent; color:#cbd5e1; border:none; border-radius:8px; padding:12px; cursor:pointer; text-align:left; transition:all 0.15s ease; font-size:14px; }
    .nav-item:hover{ background:rgba(255,255,255,0.05); color:#fff; }
    .nav-item:hover .icon svg{ color:#22d3ee; }
    .nav-item .icon{ width:20px; height:20px; display:inline-flex; align-items:center; justify-content:center; opacity:.8; flex-shrink:0; }
    .nav-item .icon svg{ width:20px; height:20px; transition:color 0.15s ease; }
    .nav-item .label{ flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-weight:400; }
    .sidebar.collapsed .nav-item .label{ display:none; }
    .nav-item.active{ background:rgba(255,255,255,0.1); color:#e2e8f0; }
    .nav-item.active .icon svg{ color:#22d3ee; }
    .sidebar .bottom{ margin-top:auto; display:flex; flex-direction:column; gap:2px; padding-top:8px; border-top:1px solid #2a2a2a; }
    .icon-btn{ background:transparent; border:none; color:#cbd5e1; border-radius:6px; padding:6px; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; transition:all 0.15s ease; }
    .icon-btn:hover{ background:rgba(255,255,255,0.1); }
    .icon-btn:hover svg{ color:#22d3ee; }
    .icon-btn svg{ transition:color 0.15s ease; }

    /* Header shift when sidebar present */
    header{ left:0; right:0; }
    @media (min-width: 900px){
      .tabs{ display:none; }
    }
    @media (max-width: 899px){
      body.has-sidebar{ padding-left:0; }
      .sidebar{ transform:translateX(-100%); width:260px; }
      .sidebar.open{ transform:translateX(0); }
    }
  </style>
</head>
<body>
  <!-- ChatGPT-like Sidebar (LTR only) -->
  <aside id="sidebar" class="sidebar" role="navigation" aria-label="Main navigation">
    <div class="top">
  <div class="brand">Score Agents</div>
      <button id="sidebarCollapse" class="icon-btn" title="Collapse/Expand" aria-label="Collapse sidebar"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" fill="currentColor"/></svg></button>
    </div>
    <ul class="nav" role="navigation">
      <li><button class="nav-item" data-tab="dashboard" title="Dashboard"><span class="icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z" fill="currentColor"/></svg></span><span class="label">Dashboard</span></button></li>
      <li><button class="nav-item" data-tab="jobs" title="Jobs"><span class="icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 6h-2.5l-1.1-1.4c-.5-.7-1.3-1.1-2.2-1.1H9.8c-.9 0-1.7.4-2.2 1.1L6.5 6H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-8 9c-1.7 0-3-1.3-3-3s1.3-3 3-3 3 1.3 3 3-1.3 3-3 3z" fill="currentColor"/></svg></span><span class="label">Jobs</span></button></li>
      <li><button class="nav-item" data-tab="candidates" title="Candidates"><span class="icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" fill="currentColor"/></svg></span><span class="label">Candidates</span></button></li>
      <li><button class="nav-item" data-tab="matches" title="Matches + Chat"><span class="icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 13.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm3-4c0 .55-.45 1-1 1s-1-.45-1-1 .45-1 1-1 1 .45 1 1zm-6 0c0 .55-.45 1-1 1s-1-.45-1-1 .45-1 1-1 1 .45 1 1z" fill="currentColor"/></svg></span><span class="label">Matches + Chat</span></button></li>
      <li><button class="nav-item" data-tab="copilot" title="Copilot"><span class="icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.94-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z" fill="currentColor"/></svg></span><span class="label">Copilot</span></button></li>
      <li><button class="nav-item" data-tab="upload" title="Upload"><span class="icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.89 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11zm-3-7v4h-2v-4H9.5L12 9.5 14.5 13H13z" fill="currentColor"/></svg></span><span class="label">Upload</span></button></li>
      <li><button class="nav-item" data-tab="imports" title="CSV Imports"><span class="icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zM6 20V4h7v5h5v11H6zm2-7h8v2H8v-2zm0 4h8v2H8v-2z" fill="currentColor"/></svg></span><span class="label">CSV Imports</span></button></li>
    </ul>
    <div class="bottom">
      <button id="sidebarLogout" class="nav-item" title="Logout"><span class="icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.59L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z" fill="currentColor"/></svg></span><span class="label">Logout</span></button>
    </div>
  </aside>

  <header role="banner" aria-label="Site header">
    <div class="brand">Recruiter Copilot</div>
    <div class="user" id="userSlot">לא מחובר</div>
  </header>
  <div class="wrap" role="main" aria-label="Main content">
  <div id="toast" style="position:fixed;top:12px;left:50%;transform:translateX(-50%);z-index:9999;display:none;background:#0b1324;border:1px solid #1f2937;color:#e2e8f0;padding:10px 14px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.35)"></div>
    <div class="tabs">
      <div class="tab active" data-tab="dashboard">לוח</div>
  <div class="tab" data-tab="jobs">משרות</div>
  <div class="tab" data-tab="candidates">מועמדים</div>
  <div class="tab" data-tab="matches">התאמות+צ'אט</div>
  <div class="tab" data-tab="copilot">Copilot</div>
      <div class="tab" data-tab="upload">העלאה</div>
  <div class="tab" data-tab="imports">ייבוא CSV</div>
      <div style="margin-inline-start:auto" class="muted"><button id="logoutBtn">התנתק</button></div>
    </div>

    <div id="dashboard" class="panel homepage">
      <section class="home-hero">
        <div class="home-copy">
          <span class="pill">Recruiter Copilot · AI SaaS</span>
          <h1>
            Recruiter <span class="accent">Copilot</span> — Chat‑first recruiting workspace
          </h1>
          <p class="lead">
            Connect your jobs and candidates to an AI copilot. Upload CSVs or sync Greenhouse, then ask the copilot to find matches, explain fit, draft outreach, and push shortlists back to your ATS — all in chat.
          </p>
          <div class="langs">English · Español</div>
          <div class="benefits">
            <div class="benefit">
              <h4>Faster hiring</h4>
              <p>Automated matching and conversational retrieval of your own talent data.</p>
            </div>
            <div class="benefit">
              <h4>Higher quality</h4>
              <p>Explainable fit analysis, skill gap highlighting, and iterative prompts.</p>
            </div>
            <div class="benefit">
              <h4>Zero friction</h4>
              <p>Chat UX, CSV import with AI field‑mapping, and 1‑click ATS sync.</p>
            </div>
            <div class="benefit">
              <h4>Network effects</h4>
              <p>Consent‑gated Open Pool boosts reach across tenants while keeping PII private.</p>
            </div>
          </div>
          <div class="features">
            <div class="feature"><h5>Chat‑native UX</h5><p>Ask for shortlists, why they fit, and next steps.</p></div>
            <div class="feature"><h5>Greenhouse integration</h5><p>Full sync + push shortlisted candidates back to ATS.</p></div>
            <div class="feature"><h5>Privacy & Compliance</h5><p>Anonymized Open Pool with candidate consent gating.</p></div>
            <div class="feature"><h5>Observability</h5><p>Sentry for errors, Papertrail/Better Stack for logs.</p></div>
          </div>
          <div class="trust" style="margin-top:10px">
            <span class="tag">FastAPI · MongoDB Atlas · OpenAI · MCP</span>
            <span class="tag">Heroku (container)</span>
            <span class="tag">SendGrid (email)</span>
          </div>
        </div>

        <div class="home-side">
          <div class="home-card home-auth" role="form" aria-labelledby="home-login-heading">
            <h3 id="home-login-heading" style="margin:0 0 8px">Login</h3>
            <div class="grid2">
              <div>
                <label for="loginEmail">Email</label>
                <input id="loginEmail" placeholder="name@company.com" autocomplete="email" inputmode="email" aria-required="true" />
              </div>
              <div>
                <label for="loginPass">Password</label>
                <input id="loginPass" type="password" placeholder="••••••••" autocomplete="current-password" aria-required="true" />
              </div>
            </div>
            <div style="margin-top:10px"><button class="primary" id="loginBtn" aria-label="Login to Recruiter Copilot">Login</button></div>
            <div class="hint" id="loginHint" role="alert" aria-live="polite"></div>
            <div class="divider"></div>
            <h3 id="home-signup-heading" style="margin:8px 0 8px">Create an account</h3>
            <div class="grid2" role="group" aria-labelledby="home-signup-heading">
              <div>
                <label for="regCompany">Company</label>
                <input id="regCompany" placeholder="Company Inc." autocomplete="organization" aria-required="true" />
              </div>
              <div>
                <label for="regName">Full name</label>
                <input id="regName" placeholder="Jane Doe" autocomplete="name" aria-required="true" />
              </div>
              <div>
                <label for="regEmail">Email</label>
                <input id="regEmail" placeholder="name@company.com" autocomplete="email" inputmode="email" aria-required="true" />
              </div>
              <div>
                <label for="regPass">Password</label>
                <input id="regPass" type="password" placeholder="Create a strong password" autocomplete="new-password" aria-required="true" />
              </div>
            </div>
            <div style="margin-top:10px"><button class="primary" id="signupBtn" aria-label="Create a new Recruiter Copilot account">Create account</button></div>
            <div class="hint" id="regHint" role="alert" aria-live="polite"></div>
          </div>
          <div class="home-card">
            <h4 style="margin:0 0 6px">Executive Summary</h4>
            <p class="small muted" style="margin:0">Recruiter Copilot is a chat‑first recruiting workspace for internal talent teams. Upload data or connect Greenhouse, then let AI accelerate sourcing, evaluation, and outreach across your private data and an anonymized Open Pool.</p>
          </div>
        </div>
      </section>
    </div>

    <div id="jobs" class="panel" style="display:none">
      <h2>משרות</h2>
      <div class="row" style="margin-bottom:10px">
        <div class="col"><input id="jobsQ" placeholder="חפש לפי כותרת/עיר/טקסט" /></div>
        <div><button id="jobsRefresh">רענן</button></div>
      </div>
      <div style="overflow:auto;max-height:60vh">
        <table>
          <thead><tr><th>מזהה</th><th>External</th><th>כותרת</th><th>עיר</th><th>AI</th><th>עודכן</th><th>פעולות</th></tr></thead>
          <tbody id="jobsT"></tbody>
        </table>
      </div>
      <div style="margin-top:8px" class="muted"><span id="jobsMeta"></span></div>
    </div>

    <div id="candidates" class="panel" style="display:none">
      <h2>מועמדים</h2>
      <div class="row" style="margin-bottom:10px">
        <div class="col"><input id="candQ" placeholder="חפש לפי שם/תפקיד/עיר/כישור" /></div>
        <div><button id="candRefresh">רענן</button></div>
      </div>
      <div style="overflow:auto;max-height:60vh">
        <table>
          <thead><tr><th>מזהה</th><th>Share</th><th>שם</th><th>כותרת</th><th>עיר</th><th>עודכן</th><th>התאמות</th><th>מכתב</th><th>פעולות</th></tr></thead>
          <tbody id="candT"></tbody>
        </table>
      </div>
      <div style="margin-top:8px" class="muted"><span id="candMeta"></span></div>
      <div class="panel" style="margin-top:14px">
        <h3>כל השדות (תצוגה רחבה)</h3>
        <div style="overflow:auto;max-height:50vh">
          <table>
            <thead><tr id="afHead"></tr></thead>
            <tbody id="afBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="upload" class="panel" style="display:none">
      <div class="row">
        <div class="col">
          <h2>העלאת משרות</h2>
          <div class="panel">
            <h3>ייבוא קובץ (CSV/XLSX/XLSM)</h3>
            <input type="file" id="jobsFile" accept=".csv,.xlsx,.xlsm" />
            <div style="margin-top:8px"><button id="jobsUpload" class="primary">ייבא קובץ</button></div>
            <div class="hint">תומך בכותרות בעברית/אנגלית. מוסיף &format=agency_template</div>
            <div id="uploadProgress" class="upload-progress" style="display:none">
              <div class="progress-bar">
                <div class="progress-fill"></div>
              </div>
              <span id="progressText">מעבד עם AI...</span>
            </div>
            <div id="jobsReport" class="muted" style="margin-top:8px"></div>
          </div>
          <div class="panel">
            <h3>משרה בודדת</h3>
            <div class="grid2">
              <input id="jobExt" placeholder="External Job ID" />
              <input id="jobTitle" placeholder="כותרת" />
              <input id="jobCity" placeholder="עיר" />
              <input id="jobEmail" placeholder="אימייל איש קשר" />
            </div>
            <textarea id="jobDesc" rows="4" placeholder="תיאור"></textarea>
            <div class="grid2">
              <input id="jobMust" placeholder="חובה: מופרד בפסיקים/שורות" />
              <input id="jobNice" placeholder="יתרון: מופרד בפסיקים/שורות" />
            </div>
            <div style="margin-top:8px"><button id="jobCreate" class="primary">צור</button> <span id="jobCreateHint" class="hint"></span></div>
          </div>
        </div>
        <div class="col">
          <h2>העלאת מועמדים</h2>
          <div class="panel">
            <h3>קבצים מרובים (PDF/TXT/DOCX)</h3>
            <div class="drop">
              <input type="file" id="candFiles" multiple accept=".pdf,.txt,.docx,.csv" />
              <div class="hint">תמיכה ב-PDF / DOCX / TXT וגם CSV בפורמט: מספר מועמד, מועמד, מספר הזמנה, השכלה, נסיון, טלפון, מייל, עיר</div>
            </div>
            <div style="margin-top:8px"><button id="candUpload" class="primary">העלה</button></div>
            <div id="candReport" class="muted" style="margin-top:8px"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="matches" class="panel" style="display:none">
      <h2>התאמות מועמדים למשרות</h2>
      <!-- Global Score Explainer (collapsible) -->
      <div class="panel" style="margin:10px 0 16px 0">
        <div style="display:flex;align-items:center;gap:10px;justify-content:space-between">
          <h3 style="margin:0">איך מחשבים את הציון?</h3>
          <button id="toggleGlobalExplainer" class="btn-small">הצג/הסתר</button>
        </div>
        <div id="globalExplainer" class="explain-card" style="margin-top:10px;display:none"></div>
      </div>
      <!-- New: Quick search by Candidate/Job ID -->
      <div class="panel" style="margin:10px 0 16px 0">
        <h3>חיפוש התאמות לפי מזהה</h3>
        <div class="row" style="align-items:end;gap:12px">
          <div class="col">
            <label style="display:block;margin-bottom:6px">סוג חיפוש</label>
            <div style="display:flex;gap:14px">
              <label><input type="radio" name="searchType" value="candidate" id="searchTypeCandidate" checked> מועמד</label>
              <label><input type="radio" name="searchType" value="job" id="searchTypeJob"> משרה</label>
            </div>
          </div>
          <div class="col">
            <label for="searchId" style="display:block;margin-bottom:6px">מזהה (24 ספרות הקסה)</label>
            <input id="searchId" placeholder="לדוגמה: 68af2e02697377761f45e4a6" />
            <div id="searchError" class="hint" style="color:#ef4444"></div>
          </div>
          <div style="width:150px">
            <label for="searchK" style="display:block;margin-bottom:6px">Top K</label>
            <input id="searchK" type="number" value="5" min="1" max="20" />
          </div>
          <div style="width:160px">
            <label style="display:block;margin-bottom:6px">סינון לפי עיר</label>
            <label><input id="searchCityFilter" type="checkbox" checked> קרבה גיאוגרפית</label>
          </div>
          <div>
            <button id="searchMatches" class="primary" disabled>חפש התאמות</button>
          </div>
        </div>
        <div id="searchResults" style="margin-top:12px;display:none" aria-live="polite"></div>
      </div>
      <!-- Phase 1: Matching controls -->
      <div class="panel" style="margin:10px 0 16px 0">
        <h3>בקרה על פרמטרי ההתאמה (ריענון בזמן אמת)</h3>
        <div class="row" style="align-items:end;gap:12px">
          <div style="width:120px">
            <label for="mK" style="display:block;margin-bottom:6px">Top K</label>
            <input id="mK" type="number" value="5" min="1" max="20" />
          </div>
          <div style="width:180px">
            <label style="display:block;margin-bottom:6px">סינון לפי קרבה</label>
            <label><input id="mCityFilter" type="checkbox" checked> קרבה גיאוגרפית</label>
          </div>
          <div style="width:180px">
            <label for="mStrategy" style="display:block;margin-bottom:6px">Cache Strategy</label>
            <select id="mStrategy">
              <option value="hybrid" selected>hybrid</option>
              <option value="on">on</option>
              <option value="off">off</option>
            </select>
          </div>
          <div style="width:180px">
            <label for="mCacheAge" style="display:block;margin-bottom:6px">Max Age (שניות)</label>
            <input id="mCacheAge" type="number" min="0" max="604800" placeholder="לדוגמה: 86400" />
          </div>
          <div style="width:220px">
            <label for="mRpESCO" style="display:block;margin-bottom:6px">Required Profession ESCO</label>
            <input id="mRpESCO" placeholder="לדוגמה: 3115" />
          </div>
          <div style="width:220px">
            <label for="mFoESCO" style="display:block;margin-bottom:6px">Field of Occupation ESCO</label>
            <input id="mFoESCO" placeholder="לדוגמה: 7223" />
          </div>
        </div>
      </div>
      <!-- Phase 2: Weights & config controls -->
      <div class="panel" style="margin:10px 0 16px 0">
        <h3>שקלול ציונים והגדרות (שרת)</h3>
        <div class="grid2" style="gap:14px">
          <div>
            <h4 style="margin:0 0 6px">משקלים עיקריים (0–1)</h4>
            <div class="grid-explain" style="gap:8px">
              <div>
                <label for="wSkills">משקל מיומנויות</label>
                <input id="wSkills" type="number" min="0" max="1" step="0.01" inputmode="decimal" placeholder="לדוגמה: 0.30" />
              </div>
              <div>
                <label for="wTitle">משקל כותרת</label>
                <input id="wTitle" type="number" min="0" max="1" step="0.01" inputmode="decimal" placeholder="לדוגמה: 0.15" />
              </div>
              <div>
                <label for="wSemantic">משקל סמנטי</label>
                <input id="wSemantic" type="number" min="0" max="1" step="0.01" inputmode="decimal" placeholder="לדוגמה: 0.20" />
              </div>
              <div>
                <label for="wEmbedding">משקל Embedding</label>
                <input id="wEmbedding" type="number" min="0" max="1" step="0.01" inputmode="decimal" placeholder="לדוגמה: 0.25" />
              </div>
              <div>
                <label for="wDistance">משקל מרחק</label>
                <input id="wDistance" type="number" min="0" max="1" step="0.01" inputmode="decimal" placeholder="לדוגמה: 0.10" />
              </div>
            </div>
          </div>
          <div>
            <h4 style="margin:0 0 6px">קטגוריות וספים</h4>
            <div class="grid-explain" style="gap:8px">
              <div>
                <label for="cwMust">משקל קטגוריית חובה</label>
                <input id="cwMust" type="number" min="0" max="1" step="0.01" inputmode="decimal" placeholder="לדוגמה: 0.70" />
                <div class="hint small">מומלץ שסכום חובה+יתרון = 1</div>
              </div>
              <div>
                <label for="cwNeeded">משקל קטגוריית יתרון</label>
                <input id="cwNeeded" type="number" min="0" max="1" step="0.01" inputmode="decimal" placeholder="לדוגמה: 0.30" />
              </div>
              <div>
                <label for="minSkillFloor">רצפת מיומנויות (מינימום)</label>
                <input id="minSkillFloor" type="number" min="0" step="1" inputmode="numeric" placeholder="לדוגמה: 0" />
              </div>
            </div>
          </div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
          <button id="weightsLoad">טען מהשרת</button>
          <button id="weightsNormalize">נרמל משקלים</button>
          <button id="weightsLocal">החל מקומית</button>
          <button id="weightsSave" class="primary">שמור לשרת</button>
          <span id="weightsStatus" class="hint"></span>
        </div>
      </div>
      <div class="row" style="margin-bottom:10px">
        <div class="col">
          <input id="matchesLimit" type="number" value="50" min="1" max="500" />
        </div>
        <div style="display:flex;gap:8px;align-items:center"><button id="matchesRefresh">רענן</button><button id="matchesClear" class="secondary">נקה סינון</button><button id="matchesUndo" class="secondary" title="בטל פעולה">בטל</button><button id="matchesRedo" class="secondary" title="בצע שוב">בצע שוב</button></div>
      </div>
      <div id="matchesChips" class="chips" style="margin:-6px 0 10px 0"></div>
      <div style="display:grid;grid-template-columns:2fr 1fr;gap:16px;align-items:start">
        <div class="panel" style="margin:0;max-height:60vh;overflow:auto">
          <table>
            <thead>
              <tr><th>מועמד</th><th>תפקיד</th><th>כמות התאמות</th><th>טופ 3</th></tr>
            </thead>
            <tbody id="matchesT"></tbody>
          </table>
          <div class="muted" id="matchesMeta" style="margin-top:8px"></div>
        </div>
        <div class="panel" style="margin:0">
          <h3>צ'אט התאמות</h3>
          <div class="chat-box">
            <div id="chatLog" class="chat-log"></div>
            <div class="chat-input">
              <input id="chatQ" placeholder="לדוגמה: כמה התאמות נמצאו היום?" />
              <button id="chatSend">שלח</button>
            </div>
            <div class="hint">הצ'אט משתמש בנתונים ממונגו ו-API של OpenAI דרך FastAPI</div>
          </div>
        </div>
      </div>
    </div>
    
    <div id="copilot" class="panel copilot-root" style="display:none">
      <div class="copilot-shell">
        <div class="hint" style="margin:4px 0 6px">Assistant is connected to your workspace. Ask anything.</div>
        <div id="copilotKpis" class="chips" aria-live="polite" style="margin:0 0 6px"></div>
        <div id="copilotUi" style="display:grid;gap:10px;margin:0 0 8px"></div>
        <div class="copilot-chat">
          <div class="chat-box">
            <div id="copilotLog" class="chat-log" aria-live="polite"></div>
            <div class="chat-input">
              <input id="copilotQ" placeholder="Message Copilot..." />
              <button id="copilotSend">Send</button>
            </div>
          </div>
          <div class="hint">Answers stream live; Copilot can use system data and actions.</div>
        </div>
      </div>
    </div>
  </div>

  <script>
  // Resolve API base robustly:
  // Priority: URL ?api=... override -> window.API_BASE -> file:// fallback -> same-origin
  // This lets the portal work when opened from file:// or a different host/port.
  const API = (() => {
    try {
      const url = new URL(location.href);
      const apiQS = url.searchParams.get('api');
      if (apiQS) return String(apiQS).replace(/\/$/, '');
      if (typeof window !== 'undefined' && window.API_BASE) return String(window.API_BASE).replace(/\/$/, '');
      if (location.protocol === 'file:') return 'http://localhost:8000';
      return location.origin;
    } catch (e) {
      return location.origin;
    }
  })();
  const state = { token:null, tenantId:null, apiKey:null, profile:null };
  try{
    const savedKey = localStorage.getItem('apiKey');
    if(savedKey){ state.apiKey = savedKey; }
    const savedTenant = localStorage.getItem('tenantId');
    if(savedTenant){ state.tenantId = savedTenant; }
    const savedToken = localStorage.getItem('token');
    if(savedToken){ state.token = savedToken; }
  }catch(e){}
  const hasAuth = () => !!state.apiKey;
  const hdrs = () => state.apiKey ? { 'X-API-Key': state.apiKey } : {};

  // Homepage visibility helpers
  function showHome(){
    try{
      document.body.classList.add('home-active');
      const sidebar = document.getElementById('sidebar');
      if(sidebar) sidebar.style.display='none';
      const wrap = document.querySelector('.wrap');
      if(wrap) wrap.style.display='block';
      const dashboard = document.getElementById('dashboard');
      if(dashboard) dashboard.style.display='block';
      // Ensure dashboard is the only visible panel
      ;['jobs','candidates','matches','copilot','upload','imports'].forEach(id=>{ const el=document.getElementById(id); if(el) el.style.display='none'; });
    }catch(e){}
  }
  function hideHome(){
    try{
      document.body.classList.remove('home-active');
      const sidebar = document.getElementById('sidebar');
      if(sidebar) sidebar.style.display='block';
      const dashboard = document.getElementById('dashboard');
      if(dashboard) dashboard.style.display='none';
    }catch(e){}
  }

  // Central matches state controlled by chat/actions and UI
  const matchesState = {
    page: 1,
    limit: 50,
    k: 5,
    cityFilter: true,
    cacheStrategy: 'hybrid',
    cacheMaxAge: 86400,
    rp_esco: '',
    fo_esco: '',
  // Live tuning knobs (phase 2 ready; read-only until actions applied)
  weights: { title:0.15, semantic:0.2, embedding:0.25, skills:0.3, distance:0.1 },
  thresholds: { mustMin:0.0, neededMin:0.0, disqualifyBelow:null },
    filters: { titleContains: '', candidateId: '', city: '', cities: [], scoreMin: null, scoreMax: null },
    sort: { by: 'score', dir: 'desc' }
  };

  // Restore tuning from localStorage
  try{
    const saved = JSON.parse(localStorage.getItem('matchesTuning')||'null');
    if(saved && typeof saved==='object'){
      Object.assign(matchesState, {
        k: Number.isFinite(Number(saved.k))? Math.max(1,Math.min(20,Number(saved.k))):5,
        cityFilter: !!saved.cityFilter,
        cacheStrategy: ['off','on','hybrid'].includes(saved.cacheStrategy)? saved.cacheStrategy : 'hybrid',
        cacheMaxAge: Number.isFinite(Number(saved.cacheMaxAge))? Math.max(0, Math.min(604800, Number(saved.cacheMaxAge))) : 86400,
        rp_esco: String(saved.rp_esco||''),
        fo_esco: String(saved.fo_esco||'')
      });
      if(saved.weights && typeof saved.weights==='object'){
        const w = saved.weights; const clamp=(x)=>Number.isFinite(Number(x))? Math.max(0, Math.min(1, Number(x))):undefined;
        matchesState.weights = {
          title: clamp(w.title) ?? 0.15,
          semantic: clamp(w.semantic) ?? 0.2,
          embedding: clamp(w.embedding) ?? 0.25,
          skills: clamp(w.skills) ?? 0.3,
          distance: clamp(w.distance) ?? 0.1,
        };
      }
      if(saved.thresholds && typeof saved.thresholds==='object'){
        const t = saved.thresholds; const c=(x)=>{ const v=Number(x); return Number.isFinite(v)? Math.max(0, Math.min(1, v)) : null; };
        matchesState.thresholds = {
          mustMin: c(t.mustMin) ?? 0,
          neededMin: c(t.neededMin) ?? 0,
          disqualifyBelow: t.disqualifyBelow!=null ? c(t.disqualifyBelow) : null
        };
      }
    }
  }catch{}

  // Simple history for undo/redo of table state
  const matchesHistory = { stack: [], idx: -1, max: 20 };
  const cloneState = (s) => JSON.parse(JSON.stringify(s));
  function pushHistory(){
    const snap = cloneState(matchesState);
    if(matchesHistory.idx < matchesHistory.stack.length-1){
      matchesHistory.stack = matchesHistory.stack.slice(0, matchesHistory.idx+1);
    }
    matchesHistory.stack.push(snap);
    if(matchesHistory.stack.length > matchesHistory.max){ matchesHistory.stack.shift(); }
    else { matchesHistory.idx++; }
    updateUndoRedoButtons();
  }
  function canUndo(){ return matchesHistory.idx > 0; }
  function canRedo(){ return matchesHistory.idx >= 0 && matchesHistory.idx < matchesHistory.stack.length-1; }
  function undo(){ if(!canUndo()) return; matchesHistory.idx--; restoreFromHistory(); }
  function redo(){ if(!canRedo()) return; matchesHistory.idx++; restoreFromHistory(); }
  function restoreFromHistory(){
    const snap = matchesHistory.stack[matchesHistory.idx];
    if(snap){
      const restored = cloneState(snap);
      matchesState.page = restored.page;
      matchesState.limit = restored.limit;
      matchesState.filters = restored.filters;
      matchesState.sort = restored.sort;
      updateUndoRedoButtons();
  renderFilterChips();
      refreshMatches();
    }
  }
  function updateUndoRedoButtons(){
    const u = document.getElementById('matchesUndo');
    const r = document.getElementById('matchesRedo');
    if(u) u.disabled = !canUndo();
    if(r) r.disabled = !canRedo();
  }

  // Validate action payloads to avoid corrupt state
  function validateAction(a){
    if(!a || typeof a !== 'object') return false;
    const t = a.type;
  if(!['setFilters','setSort','setPage','refresh','setK','setCityFilter','setCache','setESCO','setWeights','setThresholds','saveTuning'].includes(t)) return false;
    const p = a.payload || {};
    try{
      if(t==='setFilters'){
        if(p.scoreMin!=null){ let x=Number(p.scoreMin); if(!Number.isFinite(x)) return false; }
        if(p.scoreMax!=null){ let x=Number(p.scoreMax); if(!Number.isFinite(x)) return false; }
        if(p.city!=null && typeof p.city!=='string') return false;
        if(p.titleContains!=null && typeof p.titleContains!=='string') return false;
        if(p.candidateId!=null && typeof p.candidateId!=='string') return false;
      } else if(t==='setK'){
        if(p.k==null || !Number.isFinite(Number(p.k))) return false;
      } else if(t==='setCityFilter'){
        if(typeof p.enabled!=='boolean') return false;
      } else if(t==='setCache'){
        if(p.strategy!=null && !['off','on','hybrid'].includes(String(p.strategy))) return false;
        if(p.maxAge!=null && !Number.isFinite(Number(p.maxAge))) return false;
      } else if(t==='setESCO'){
        if(p.rp!=null && typeof p.rp!=='string') return false;
        if(p.fo!=null && typeof p.fo!=='string') return false;
      } else if(t==='setSort'){
        if(p.by && !['score','date','title'].includes(String(p.by))) return false;
        if(p.dir && !['asc','desc'].includes(String(p.dir))) return false;
      } else if(t==='setWeights'){
        const keys=['title','semantic','embedding','skills','distance'];
        for(const k of keys){ if(p[k]!=null && !Number.isFinite(Number(p[k]))) return false; }
      } else if(t==='setThresholds'){
        if(p.mustMin!=null && !Number.isFinite(Number(p.mustMin))) return false;
        if(p.neededMin!=null && !Number.isFinite(Number(p.neededMin))) return false;
        if(p.disqualifyBelow!=null && !Number.isFinite(Number(p.disqualifyBelow))) return false;
      } else if(t==='setPage'){
        if(p.page!=null && (!Number.isFinite(Number(p.page)) || Number(p.page) < 1)) return false;
      }
      return true;
    }catch{ return false; }
  }

  // Debounced refresh for control changes
  let matchesRefreshT;
  function scheduleRefreshMatches(){
    try{ clearTimeout(matchesRefreshT); }catch{}
  try{ localStorage.setItem('matchesTuning', JSON.stringify({ k: matchesState.k, cityFilter: matchesState.cityFilter, cacheStrategy: matchesState.cacheStrategy, cacheMaxAge: matchesState.cacheMaxAge, rp_esco: matchesState.rp_esco, fo_esco: matchesState.fo_esco, weights: matchesState.weights, thresholds: matchesState.thresholds })); }catch{}
    matchesRefreshT = setTimeout(()=>{ refreshMatches(); }, 250);
  }

  // Centralized fetch wrapper: force no-store and merge headers
  async function apiFetch(input, init={}){
    const baseHeaders = { 'Pragma': 'no-cache', 'Cache-Control': 'no-store', ...hdrs() };
    const merged = { cache: 'no-store', ...init, headers: { ...baseHeaders, ...(init.headers||{}) } };
    return fetch(input, merged);
  }

  function toast(msg, kind='info', ms=3500){
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.style.borderColor = kind==='error' ? '#ef4444' : kind==='ok' ? '#10b981' : '#334155';
    el.style.display = 'block';
    clearTimeout(window.__toastT);
    window.__toastT = setTimeout(()=>{ el.style.display='none'; }, ms);
  }

  // ===== Score Explainer: renderer and helpers =====
  function pct100(v){ if(v==null) return '—'; const x=Math.max(0, Math.min(1, Number(v)||0)); return (x*100).toFixed(0)+'%'; }
  function clamp01(v){ const n=Number(v); if(!Number.isFinite(n)) return 0; return Math.max(0, Math.min(1, n)); }
  function barHtml(value){ const p = Math.round(clamp01(value)*100); return `<div class="meter" aria-label="${p}%"><span style="width:${p}%"></span></div>`; }
  function kv(label, value){ return `<div><div class="muted small" style="font-size:12px">${label}</div><div>${value}</div></div>`; }
  function fmtNum(v, digits=3){ const n=Number(v); return Number.isFinite(n)? n.toFixed(digits) : '—'; }
  function asMonospace(obj){ const s = typeof obj==='string'? obj : JSON.stringify(obj,null,2); return `<pre style="background:#0a1428;border:1px solid #1f2937;border-radius:8px;padding:10px;overflow:auto;max-height:240px">${escapeHtml(s)}</pre>`; }
  function normalizeWeights(w){
    const {title=0,semantic=0,embedding=0,skills=0,distance=0} = w||{}; const sum = [title,semantic,embedding,skills,distance].reduce((a,b)=>a+(Number(b)||0),0) || 1;
    return { title: (title||0)/sum, semantic:(semantic||0)/sum, embedding:(embedding||0)/sum, skills:(skills||0)/sum, distance:(distance||0)/sum };
  }
  function renderGlobalExplainer(){
    const el = document.getElementById('globalExplainer'); if(!el) return;
    const w = normalizeWeights(matchesState.weights||{});
    const th = matchesState.thresholds||{};
    el.innerHTML = `
      <div class="grid-explain cols-2">
        <div>
          <h4 style="margin:0 0 6px">מרכיבי ציון</h4>
          ${kv('דמיון כותרת', pct100(null))}
          ${barHtml(null)}
          ${kv('דמיון סמנטי', pct100(null))}
          ${barHtml(null)}
          ${kv('דמיון embedding', pct100(null))}
          ${barHtml(null)}
          ${kv('ציון מיומנויות משוקלל', pct100(null))}
          ${barHtml(null)}
          ${kv('ציון מרחק', pct100(null))}
          ${barHtml(null)}
          <div class="muted" style="margin-top:6px">דוגמה כללית – ערכים ספציפיים יוצגו לכל התאמה בתוך הטבלה.</div>
        </div>
        <div>
          <h4 style="margin:0 0 6px">משקלים וספים</h4>
          <div class="grid-explain">
            ${kv('משקל כותרת', (w.title*100).toFixed(0)+'%')}
            ${kv('משקל סמנטי', (w.semantic*100).toFixed(0)+'%')}
            ${kv('משקל embedding', (w.embedding*100).toFixed(0)+'%')}
            ${kv('משקל מיומנויות', (w.skills*100).toFixed(0)+'%')}
            ${kv('משקל מרחק', (w.distance*100).toFixed(0)+'%')}
          </div>
          <div style="margin-top:8px" class="grid-explain">
            ${kv('סף חובה מינימלי', th.mustMin!=null? pct100(th.mustMin):'—')}
            ${kv('סף יתרון מינימלי', th.neededMin!=null? pct100(th.neededMin):'—')}
            ${kv('פסילה מתחת ל-', th.disqualifyBelow!=null? pct100(th.disqualifyBelow):'—')}
          </div>
          <div class="muted" style="margin-top:6px">הציון הסופי הוא סכום התרומות: Σ(weight × feature), לאחר נרמול וגדרות (gates) כגון חובת חובה/מרחק.</div>
        </div>
      </div>`;
  }

  // Helpers for weights form
  function clamp01Num(v){ const n=Number(v); if(!Number.isFinite(n)) return 0; return Math.max(0, Math.min(1, n)); }
  function readWeightsForm(){
    const g = (id)=>document.getElementById(id);
    const v = {
      skills: clamp01Num(g('wSkills')?.value),
      title: clamp01Num(g('wTitle')?.value),
      semantic: clamp01Num(g('wSemantic')?.value),
      embedding: clamp01Num(g('wEmbedding')?.value),
      distance: clamp01Num(g('wDistance')?.value),
      must: clamp01Num(g('cwMust')?.value),
      needed: clamp01Num(g('cwNeeded')?.value),
      minSkillFloor: Math.max(0, Math.floor(Number(g('minSkillFloor')?.value||0)))
    };
    return v;
  }
  function fillWeightsForm(from){
    const g = (id)=>document.getElementById(id);
    if(from.skills!=null) g('wSkills').value = String(from.skills);
    if(from.title!=null) g('wTitle').value = String(from.title);
    if(from.semantic!=null) g('wSemantic').value = String(from.semantic);
    if(from.embedding!=null) g('wEmbedding').value = String(from.embedding);
    if(from.distance!=null) g('wDistance').value = String(from.distance);
    if(from.must!=null) g('cwMust').value = String(from.must);
    if(from.needed!=null) g('cwNeeded').value = String(from.needed);
    if(from.minSkillFloor!=null) g('minSkillFloor').value = String(from.minSkillFloor);
  }
  function normalizeMainWeights(obj){
    const s = (Number(obj.skills)||0)+(Number(obj.title)||0)+(Number(obj.semantic)||0)+(Number(obj.embedding)||0)+(Number(obj.distance)||0);
    if(s<=0) return obj; // nothing to do
    return {
      ...obj,
      skills: (Number(obj.skills)||0)/s,
      title: (Number(obj.title)||0)/s,
      semantic: (Number(obj.semantic)||0)/s,
      embedding: (Number(obj.embedding)||0)/s,
      distance: (Number(obj.distance)||0)/s,
    };
  }
  async function loadServerConfig(){
    const status = document.getElementById('weightsStatus'); if(status) status.textContent='';
    try{
      const r = await apiFetch(`${API}/match/config`, { headers: hdrs() });
      if(!r.ok){ if(status) status.textContent='שגיאה בטעינה'; return; }
      const j = await r.json();
      const vals = {
        skills: Number(j.skill_weight ?? matchesState.weights.skills ?? 0.3),
        title: Number(j.title_weight ?? matchesState.weights.title ?? 0.15),
        semantic: Number(j.semantic_weight ?? matchesState.weights.semantic ?? 0.2),
        embedding: Number(j.embedding_weight ?? matchesState.weights.embedding ?? 0.25),
        distance: Number(j.distance_weight ?? matchesState.weights.distance ?? 0.1),
        must: Number(j.must_category_weight ?? 0.7),
        needed: Number(j.needed_category_weight ?? 0.3),
        minSkillFloor: Number.isFinite(Number(j.min_skill_floor)) ? Number(j.min_skill_floor) : ''
      };
      fillWeightsForm(vals);
      // Update local state weights (display only) without saving to server
      matchesState.weights = { title: vals.title, semantic: vals.semantic, embedding: vals.embedding, skills: vals.skills, distance: vals.distance };
      renderGlobalExplainer();
      if(status) status.textContent='נטען מהשרת';
    }catch(e){ if(status) status.textContent='שגיאה'; }
  }
  async function saveServerConfig(){
    const status = document.getElementById('weightsStatus'); if(status) status.textContent='';
    if(!hasAuth()){ toast('התחבר כדי לשמור בשרת','warn'); return; }
    let v = readWeightsForm();
    // Basic validation for category weights sum
    const sumCat = (Number(v.must)||0) + (Number(v.needed)||0);
    if(Math.abs(sumCat-1) > 0.01){
      // Auto-balance needed if must provided
      v.needed = Math.max(0, Math.min(1, 1 - (Number(v.must)||0)));
      document.getElementById('cwNeeded').value = String(v.needed.toFixed(2));
    }
    // Prepare payload
    const payload = {
      skill_weight: Number(v.skills),
      title_weight: Number(v.title),
      semantic_weight: Number(v.semantic),
      embed_weight: Number(v.embedding),
      distance_weight: Number(v.distance),
      must_weight: Number(v.must),
      needed_weight: Number(v.needed),
      min_skill_floor: Number.isFinite(Number(v.minSkillFloor)) ? Number(v.minSkillFloor) : undefined
    };
    try{
      const r = await apiFetch(`${API}/match/config`, { method:'PUT', headers: { ...hdrs(), 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      if(!r.ok){ const txt = await r.text(); toast('שמירה נכשלה: '+(txt||r.status),'error'); return; }
      const j = await r.json();
      // Reflect saved server values in form + state
      const vals = {
        skills: Number(j.skill_weight ?? v.skills),
        title: Number(j.title_weight ?? v.title),
        semantic: Number(j.semantic_weight ?? v.semantic),
        embedding: Number(j.embedding_weight ?? v.embedding),
        distance: Number(j.distance_weight ?? v.distance),
        must: Number(j.must_category_weight ?? v.must),
        needed: Number(j.needed_category_weight ?? v.needed),
        minSkillFloor: Number(j.min_skill_floor ?? v.minSkillFloor)
      };
      fillWeightsForm(vals);
      matchesState.weights = { title: vals.title, semantic: vals.semantic, embedding: vals.embedding, skills: vals.skills, distance: vals.distance };
      renderGlobalExplainer();
      try{ localStorage.setItem('matchesConfigForm', JSON.stringify(vals)); }catch{}
      toast('נשמר בשרת ✅','ok');
      scheduleRefreshMatches();
    }catch(e){ toast('שגיאת רשת','error'); }
  }
  function applyLocalWeights(){
    let v = readWeightsForm();
    // Optionally normalize main weights before applying locally
    v = normalizeMainWeights(v);
    matchesState.weights = { title: v.title, semantic: v.semantic, embedding: v.embedding, skills: v.skills, distance: v.distance };
    try{ localStorage.setItem('matchesConfigForm', JSON.stringify(v)); }catch{}
    renderGlobalExplainer();
    toast('הוחל מקומית','ok');
  }
  function normalizeWeightsForm(){
    const v = normalizeMainWeights(readWeightsForm());
    fillWeightsForm(v);
    toast('נרמל משקלים','ok');
  }

  function showUser(){
    const el = document.getElementById('userSlot');
    if(hasAuth()){
      const name = state.profile?.user?.name || '';
      const comp = state.profile?.tenant?.name || '';
      el.textContent = `שלום ${name} (${comp})`;
    } else {
      el.textContent = 'לא מחובר';
    }
    // Reflect auth in weights save button
    try{
      const saveBtn = document.getElementById('weightsSave');
      if(saveBtn) saveBtn.disabled = !hasAuth();
    }catch(e){}
  }
  function activate(tab){
    document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active', t.dataset.tab===tab));
    ['dashboard','jobs','candidates','matches','copilot','upload','imports'].forEach(id=>{
      const el = document.getElementById(id);
      if(el){ el.style.display = (id===tab)?'block':'none'; }
    });
    // Copilot full-screen mode toggler
    try{
      document.body.classList.toggle('copilot-active', tab==='copilot');
    }catch(e){}
    // Reflect active state in sidebar nav
    try{
      document.querySelectorAll('.nav .nav-item').forEach(b=>{
        b.classList.toggle('active', b.dataset.tab===tab);
      });
    }catch(e){}
    if(tab==='matches'){
  // Prepare global explainer once visible
  try{ renderGlobalExplainer(); }catch(e){}
      refreshMatches();
    }
    if(tab==='copilot'){
      // No auto actions; UI awaits user prompt
    }
    if(tab==='jobs') refreshJobs();
    if(tab==='candidates') refreshCandidates();
  }
  document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click', ()=> { 
    const tab = t.dataset.tab; 
    try{ localStorage.setItem('activeTab', tab); }catch(e){}
    try{ location.hash = tab; }catch(e){}
    activate(tab); 
  }));
  const _logoutBtn = document.getElementById('logoutBtn');
  if(_logoutBtn) _logoutBtn.onclick = ()=>{
    // Clear auth + UI to avoid any stale cross-tenant view
    state.token=null; state.apiKey=null; state.tenantId=null; state.profile=null;
    try{ localStorage.removeItem('apiKey'); localStorage.removeItem('tenantId'); localStorage.removeItem('token'); }catch(e){}
    try{
  ['jobsT','candT','afBody','matchesT','chatLog'].forEach(id=>{ const el=document.getElementById(id); if(el) el.innerHTML=''; });
  ['jobsMeta','candMeta','matchesMeta'].forEach(id=>{ const el=document.getElementById(id); if(el) el.textContent=''; });
      ['jobModal','candidateModal','matchesModal','letterModal'].forEach(id=>{ const el=document.getElementById(id); if(el) el.style.display='none'; });
    }catch(e){}
    showUser();
  // Switch to homepage full-screen
  try{ showHome(); }catch(e){}
  };

  // Sidebar (ChatGPT-like) wiring
  (function initSidebar(){
    const body = document.body;
    const sidebar = document.getElementById('sidebar');
    const collapseBtn = document.getElementById('sidebarCollapse');
    const sideLogout = document.getElementById('sidebarLogout');
    if(!sidebar){ return; }
    body.classList.add('has-sidebar');

    const isDesktop = () => window.matchMedia('(min-width: 900px)').matches;
    // Restore collapsed state
    try{
      const collapsed = localStorage.getItem('sidebarCollapsed') === '1';
      if(collapsed) {
        sidebar.classList.add('collapsed');
        body.classList.add('sidebar-collapsed');
      }
    }catch(e){}

    function setCollapsed(v){
      if(v){ 
        sidebar.classList.add('collapsed'); 
        body.classList.add('sidebar-collapsed');
      }
      else { 
        sidebar.classList.remove('collapsed'); 
        body.classList.remove('sidebar-collapsed');
      }
      try{ localStorage.setItem('sidebarCollapsed', v?'1':'0'); }catch(e){}
    }

    function toggleDesktop(){ setCollapsed(!sidebar.classList.contains('collapsed')); }
    function toggleMobile(){ sidebar.classList.toggle('open'); }

    if(collapseBtn && !collapseBtn._bound){
      collapseBtn._bound = true;
      collapseBtn.addEventListener('click', ()=>{ isDesktop()? toggleDesktop() : toggleMobile(); });
    }
    if(sideLogout && !sideLogout._bound){
      sideLogout._bound = true;
      sideLogout.addEventListener('click', ()=>{
        const l = document.getElementById('logoutBtn');
        if(l) l.click();
      });
    }

    // Nav items → activate tabs
    document.querySelectorAll('.nav .nav-item').forEach(btn=>{
      if(btn._bound) return; btn._bound=true;
      btn.addEventListener('click', ()=>{
        const tab = btn.dataset.tab;
        try{ localStorage.setItem('activeTab', tab); }catch(e){}
        activate(tab);
        if(!isDesktop()) sidebar.classList.remove('open');
      });
    });

    // Keep layout sensible on resize (close mobile sheet when returning to desktop)
    const mq = window.matchMedia('(min-width: 900px)');
    function onChange(){ if(mq.matches){ sidebar.classList.remove('open'); } }
    try{ mq.addEventListener('change', onChange); }catch(e){ mq.onchange = onChange; }
  })();

  // Toggle global explainer panel
  (function bindGlobalExplainerToggle(){
    const btn = document.getElementById('toggleGlobalExplainer');
    const el = document.getElementById('globalExplainer');
    if(btn && el && !btn._bound){
      btn._bound = true;
      btn.addEventListener('click', ()=>{
        if(el.style.display==='none' || !el.style.display){ el.style.display='block'; renderGlobalExplainer(); }
        else { el.style.display='none'; }
      });
    }
  })();

  // Signup
  document.getElementById('signupBtn').onclick = async () => {
    const company = document.getElementById('regCompany').value.trim();
    const name = document.getElementById('regName').value.trim();
    const email = document.getElementById('regEmail').value.trim();
    const password = document.getElementById('regPass').value;
    const hint = document.getElementById('regHint');
  // reset validity
  ['regCompany','regName','regEmail','regPass'].forEach(id=>{ const el=document.getElementById(id); if(el) el.removeAttribute('aria-invalid'); });
    hint.textContent='';
    try{
      const r = await apiFetch(`${API}/auth/signup`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({company,name,email,password})});
      if(!r.ok){
        const txt = await r.text();
    ['regCompany','regName','regEmail','regPass'].forEach(id=>{ const el=document.getElementById(id); if(el && !el.value) el.setAttribute('aria-invalid','true'); });
    throw new Error(txt || `HTTP ${r.status}`);
      }
      const j = await r.json();
      state.token = j.token; state.tenantId = j.tenant_id;
      const k = await apiFetch(`${API}/auth/apikey`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({tenant_id: state.tenantId, name: 'portal'})});
  const kj = await k.json();
  state.apiKey = kj.key;
  try{ localStorage.setItem('apiKey', state.apiKey); localStorage.setItem('tenantId', state.tenantId||''); localStorage.setItem('token', state.token||''); }catch(e){}
  try{ const me = await apiFetch(`${API}/auth/me`, {headers:{'Authorization':`Bearer ${state.token}`}}); state.profile = me.ok ? await me.json() : null; }catch(e){}
  showUser(); hideHome(); activate('copilot');
  hint.textContent = 'נוצר. ניתן להתחיל לעבוד.';
  }catch(e){ hint.textContent = `שגיאה בהרשמה: ${String(e && e.message || e).slice(0,140)}`; }
  };

  // Login
  document.getElementById('loginBtn').onclick = async () => {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPass').value;
    const hint = document.getElementById('loginHint');
  ['loginEmail','loginPass'].forEach(id=>{ const el=document.getElementById(id); if(el) el.removeAttribute('aria-invalid'); });
    hint.textContent='';
    try{
      const r = await apiFetch(`${API}/auth/login`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({email,password})});
      if(!r.ok){
        const txt = await r.text();
    ['loginEmail','loginPass'].forEach(id=>{ const el=document.getElementById(id); if(el && !el.value) el.setAttribute('aria-invalid','true'); });
    throw new Error(txt || `HTTP ${r.status}`);
      }
      const j = await r.json();
      state.token = j.token; state.tenantId = j.tenant_id;
      const k = await apiFetch(`${API}/auth/apikey`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({tenant_id: state.tenantId, name: 'portal'})});
  const kj = await k.json();
  state.apiKey = kj.key;
  try{ localStorage.setItem('apiKey', state.apiKey); localStorage.setItem('tenantId', state.tenantId||''); localStorage.setItem('token', state.token||''); }catch(e){}
  try{ const me = await apiFetch(`${API}/auth/me`, {headers:{'Authorization':`Bearer ${state.token}`}}); state.profile = me.ok ? await me.json() : null; }catch(e){}
  showUser(); hideHome(); activate('copilot');
  // Preload data in background while user starts with Copilot
  Promise.allSettled([refreshJobs(), refreshCandidates()]);
    }catch(e){ hint.textContent = `שגיאה בהתחברות: ${String(e && e.message || e).slice(0,140)}`; }
  };

  // Jobs list
  async function refreshJobs(){
    if(!hasAuth()) return;
    const q = document.getElementById('jobsQ').value.trim();
    const url = new URL(`${API}/tenant/jobs`);
    if(q) url.searchParams.set('q', q);
    const r = await apiFetch(url, {headers: hdrs()});
    if(!r.ok){ document.getElementById('jobsMeta').textContent='שגיאה'; return; }
    const j = await r.json();
    const tb = document.getElementById('jobsT'); tb.innerHTML='';
    j.results.forEach(row=>{
      const llmBadge = row.llm_success ? 
        '<span class="badge success">✓ AI</span>' : 
        row.llm_used ? 
        '<span class="badge warning">⚠️ AI</span>' :
        '<span class="badge neutral">○ בסיסי</span>';
      const tr = document.createElement('tr');
      tr.innerHTML = `<td style="direction:ltr">${row.job_id}</td><td>${row.external_job_id||''}</td><td>${row.title||''}</td><td>${row.city||''}</td><td>${llmBadge}</td><td>${row.updated_at||''}</td><td><button onclick="showJobDetails('${row.job_id}')" class="btn-small">פרטים</button></td>`;
      tb.appendChild(tr);
    });
    document.getElementById('jobsMeta').textContent = `סה"כ ${j.total} רשומות`;
  }
  const _jobsRefresh = document.getElementById('jobsRefresh');
  if(_jobsRefresh) _jobsRefresh.onclick = refreshJobs;

  // Candidates list
  async function refreshCandidates(){
    if(!hasAuth()) return;
    const q = document.getElementById('candQ').value.trim();
    const url = new URL(`${API}/tenant/candidates`);
    if(q) url.searchParams.set('q', q);
    const r = await apiFetch(url, {headers: hdrs()});
    if(!r.ok){ document.getElementById('candMeta').textContent='שגיאה'; return; }
    const j = await r.json();
    const tb = document.getElementById('candT'); tb.innerHTML='';
    
    // First, render basic candidate info immediately
    j.results.forEach(row => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="direction:ltr">${row.candidate_id}</td>
        <td>${row.share_id||''}</td>
        <td>${row.full_name||''}</td>
        <td>${row.title||''}</td>
        <td>${row.city||''}</td>
        <td>${row.updated_at||''}</td>
        <td><span class="muted">טוען...</span></td>
        <td><span class="muted">טוען...</span></td>
        <td>
          <button class="btn-small" onclick="showCandidateDetails('${row.candidate_id}')">פרטים</button>
          <button class="btn-small" onclick="showJobMatches('${row.candidate_id}')">התאמות</button>
          ${row.share_id ? `<button class=\"btn-small\" onclick=\"showPersonalLetter('${row.share_id}')\">מכתב</button>` : ''}
          ${row.share_id ? `<button class=\"btn-small\" onclick=\"generatePersonalLetter('${row.share_id}')\">יצירת מכתב</button>` : ''}
        </td>
      `;
      tb.appendChild(tr);
    });
    
    document.getElementById('candMeta').textContent = `סה"כ ${j.total} רשומות`;
    
    // Then, asynchronously load status for each candidate
    j.results.forEach(async (row, index) => {
      const tr = tb.children[index];
      const matchesCell = tr.children[6];
      const letterCell = tr.children[7];
      
      try {
        // Check for job matches
        const matchesR = await apiFetch(`${API}/match/candidate/${row.candidate_id}?k=5`, {headers: hdrs()});
        if(matchesR.ok) {
          const matchesData = await matchesR.json();
          const matchCount = matchesData.matches?.length || 0;
          if(matchCount > 0) {
            matchesCell.innerHTML = `<span class=\"badge success\">${matchCount} התאמות</span>`;
          } else {
            matchesCell.innerHTML = '<span class=\"badge neutral\">אין התאמות</span>';
          }
        } else {
          matchesCell.innerHTML = '<span class=\"badge warning\">שגיאה</span>';
        }
        
        // Check for personal letter
        if(row.share_id) {
          // Use lightweight availability endpoint to avoid triggering generation or rate limits
          const letterAvail = await apiFetch(`${API}/personal-letter/availability/${row.share_id}`, {headers: hdrs()});
          if(letterAvail.ok) {
            const jAvail = await letterAvail.json();
            if (jAvail.available) {
              letterCell.innerHTML = '<span class=\"badge success\">✓ מכתב</span>';
            } else {
              const missing = (jAvail.missing || []).join(', ');
              letterCell.innerHTML = `<span class=\"badge neutral\" title=\"חסרים: ${missing}\">○ אין מכתב</span>`;
            }
          } else if (letterAvail.status === 429) {
            letterCell.innerHTML = '<span class=\"badge warning\" title=\"מוגבלות קצב\">429</span>';
          } else {
            letterCell.innerHTML = '<span class=\"badge warning\">שגיאה</span>';
          }
        } else {
          letterCell.innerHTML = '<span class=\"muted\">אין Share ID</span>';
        }
      } catch(e) {
        console.warn('Error loading candidate status:', e);
        matchesCell.innerHTML = '<span class=\"badge warning\">שגיאה</span>';
        letterCell.innerHTML = '<span class=\"badge warning\">שגיאה</span>';
      }
    });

    // all_fields (first page)
    const r2 = await apiFetch(`${API}/tenant/candidates/all_fields?skip=0&limit=20`, {headers: hdrs()});
    if(r2.ok){
      const jj = await r2.json();
      const head = document.getElementById('afHead'); head.innerHTML='';
      jj.columns.forEach(c=>{ const th=document.createElement('th'); th.textContent=c; head.appendChild(th); });
      const body = document.getElementById('afBody'); body.innerHTML='';
      jj.rows.forEach(rw=>{
        const tr=document.createElement('tr');
        tr.innerHTML = jj.columns.map(c=>`<td style="font-size:11px;white-space:nowrap;max-width:240px;overflow:hidden;text-overflow:ellipsis">${(rw[c]??'')}</td>`).join('');
        body.appendChild(tr);
      });
    }
  }
  const _candRefresh = document.getElementById('candRefresh');
  if(_candRefresh) _candRefresh.onclick = refreshCandidates;

  // Matches report (CV ↔ Jobs)
  let matchesAbort; // AbortController for in-flight refreshes
  async function refreshMatches(){
    if(!hasAuth()) return;
    // sync limit from input
    const limitInp = Number(document.getElementById('matchesLimit').value||matchesState.limit||50);
    matchesState.limit = Math.min(Math.max(limitInp,1),500);
    const f = matchesState.filters || {};
    // Render chips for current filters
    renderFilterChips();
    // Decide endpoint based on multi-city presence
    const usePost = Array.isArray(f.cities) && f.cities.length > 0;
    const url = usePost ? `${API}/match/report/query` : new URL(`${API}/match/report`);
    const payload = usePost ? {
      k: Math.max(1, Math.min(20, Number(matchesState.k||5))),
      limit: matchesState.limit,
      page: matchesState.page,
      city_filter: !!matchesState.cityFilter,
      cache_strategy: matchesState.cacheStrategy || 'hybrid',
      cache_max_age: Number.isFinite(Number(matchesState.cacheMaxAge)) ? Number(matchesState.cacheMaxAge) : undefined,
      rp_esco: matchesState.rp_esco || undefined,
      fo_esco: matchesState.fo_esco || undefined,
      title_contains: f.titleContains || undefined,
      candidate_id: f.candidateId || undefined,
      city_in: (f.cities && f.cities.length) ? f.cities : (f.city ? [f.city] : undefined),
      score: (f.scoreMin!=null || f.scoreMax!=null) ? { ...(f.scoreMin!=null ? {"$gte": f.scoreMin} : {}), ...(f.scoreMax!=null ? {"$lte": f.scoreMax} : {}) } : undefined,
      sort_by: matchesState.sort?.by || 'score',
      sort_dir: matchesState.sort?.dir || 'desc',
    } : null;
    if(!usePost){
      const u = url; // URL object
      u.searchParams.set('k', String(Math.max(1, Math.min(20, Number(matchesState.k||5)))));
      u.searchParams.set('limit', String(matchesState.limit));
      u.searchParams.set('skip', String(Math.max((matchesState.page-1),0) * matchesState.limit));
      u.searchParams.set('city_filter', String(!!matchesState.cityFilter));
      if(matchesState.cacheStrategy) u.searchParams.set('cache_strategy', matchesState.cacheStrategy);
      if(Number.isFinite(Number(matchesState.cacheMaxAge))) u.searchParams.set('cache_max_age', String(matchesState.cacheMaxAge));
      if(matchesState.rp_esco) u.searchParams.set('rp_esco', matchesState.rp_esco);
      if(matchesState.fo_esco) u.searchParams.set('fo_esco', matchesState.fo_esco);
      if(f.titleContains) u.searchParams.set('title_contains', f.titleContains);
      if(f.candidateId) u.searchParams.set('candidate_id', f.candidateId);
      if(f.city) u.searchParams.set('city', f.city);
      if(f.scoreMin!=null) u.searchParams.set('score_min', String(f.scoreMin));
      if(f.scoreMax!=null) u.searchParams.set('score_max', String(f.scoreMax));
      if(matchesState.sort?.by) u.searchParams.set('sort_by', matchesState.sort.by);
      if(matchesState.sort?.dir) u.searchParams.set('sort_dir', matchesState.sort.dir);
    }
    const meta = document.getElementById('matchesMeta');
    meta.textContent = 'טוען...';
    try{
      if(matchesAbort) matchesAbort.abort();
    }catch{}
    matchesAbort = new AbortController();
    let r;
    try{
      if(usePost){
        r = await apiFetch(url, { method:'POST', headers: { ...hdrs(), 'Content-Type':'application/json' }, body: JSON.stringify(payload), signal: matchesAbort.signal });
      } else {
        r = await apiFetch(url, { headers: hdrs(), signal: matchesAbort.signal });
      }
    }catch(e){
      if(e.name==='AbortError') return; // superseded
      const tb = document.getElementById('matchesT'); tb.innerHTML='';
      meta.textContent = 'שגיאת רשת';
      return;
    }
    const tb = document.getElementById('matchesT');
    tb.innerHTML = '';
    if(!r.ok){
      const msg = r.status===401? 'לא מורשה' : r.status===404? 'לא נמצא' : r.status===429? 'מוגבלות קצב' : 'שגיאה';
      meta.textContent = '';
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="4"><div class="empty-state">טעינת התאמות נכשלה (${msg}). <button id="matchesRetry">נסה שוב</button> <button id="matchesDemo">טען דמו</button></div></td>`;
      tb.appendChild(tr);
      const retry = document.getElementById('matchesRetry');
      const demo = document.getElementById('matchesDemo');
      if(retry) retry.onclick = refreshMatches;
      if(demo) demo.onclick = async ()=>{ try{ await apiFetch(`${API}/bootstrap`, {method:'POST', headers: hdrs()}); }catch(e){} refreshMatches(); };
      return;
    }
    const j = await r.json();
    const rows = j.results||[];
    if(rows.length===0){
      meta.textContent = '';
      const tr = document.createElement('tr');
      const hintBits = [];
      if(f.scoreMin!=null) hintBits.push(`ציון מינימלי ${(Number(f.scoreMin)*100).toFixed(0)}%`);
      if(f.city) hintBits.push(`עיר ${f.city}`);
      if(Array.isArray(f.cities) && f.cities.length) hintBits.push(`ערים: ${f.cities.join(', ')}`);
      const hint = hintBits.length? ` (סינון: ${hintBits.join(' • ')})` : '';
      tr.innerHTML = `<td colspan="4"><div class="empty-state">אין נתונים להצגה${hint}. נסה להרחיב את הסינון, לאפס עם "נקה סינון", או <button id="matchesDemo">טען דמו</button></div></td>`;
      tb.appendChild(tr);
      const demo = document.getElementById('matchesDemo');
      if(demo) demo.onclick = async ()=>{ try{ await apiFetch(`${API}/bootstrap`, {method:'POST', headers: hdrs()}); }catch(e){} refreshMatches(); };
      return;
    }
    rows.forEach(row=>{
      const matches = Array.isArray(row.matches) ? row.matches : [];
      const top = matches.slice(0,3).map(m=>`${escapeHtml(m.title||'משרה')} (${Math.round((m.score||0)*100)}%)`).join(' • ');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="direction:ltr">${row.candidate_id}</td>
        <td>${escapeHtml(row.title||'')}</td>
        <td>${matches.length}</td>
        <td>
          ${top}
          ${matches.length ? ` <button class="btn-small" data-cand-expander="${row.candidate_id}">פירוט</button>` : ''}
        </td>`;
      const exp = document.createElement('tr');
      exp.id = `cand-exp-${row.candidate_id}`;
      exp.style.display = 'none';
      const rowsHtml = matches.slice(0,5).map(m=>{
        const score = Math.round(((m.score||0)*100));
        const badge = `<span class="badge ${score>=70?'success':score>=40?'warning':'neutral'}">${score}%</span>`;
        return `<tr>
          <td style="direction:ltr">${m.job_id||''}</td>
          <td>${escapeHtml(m.title||'')}</td>
          <td>${badge}</td>
          <td>
            <button class="btn-small" data-bd="1" data-cand="${row.candidate_id}" data-job="${m.job_id||''}">פירוט התאמה</button>
          </td>
        </tr>
        <tr class="bd-row" id="bd-${row.candidate_id}-${m.job_id||''}" style="display:none"><td colspan="4"><div class="empty-state">טוען...</div></td></tr>`;
      }).join('');
      exp.innerHTML = `<td colspan="4">
        <div class="panel" style="margin:8px 0 0 0">
          <div class="muted" style="margin-bottom:6px">חמש המשרות הראשונות עבור מועמד זה</div>
          <div style="overflow:auto;max-height:34vh">
            <table>
              <thead><tr><th>משרה</th><th>כותרת</th><th>ציון</th><th>פעולות</th></tr></thead>
              <tbody>${rowsHtml || '<tr><td colspan="4" class="muted">אין פריטים</td></tr>'}</tbody>
            </table>
          </div>
        </div>
      </td>`;
      tb.appendChild(tr);
      tb.appendChild(exp);
    });
    // Delegate clicks for expanders and breakdown toggles (bind once)
    if(!tb._bdBound){
      tb.addEventListener('click', async (ev)=>{
        const expBtn = ev.target.closest('button[data-cand-expander]');
        if(expBtn){
          const cid = expBtn.getAttribute('data-cand-expander');
          const expRow = document.getElementById(`cand-exp-${cid}`);
          if(expRow){ expRow.style.display = (expRow.style.display==='none' || !expRow.style.display) ? 'table-row' : 'none'; }
          return;
        }
        const bdBtn = ev.target.closest('button[data-bd]');
        if(bdBtn){
          const cand = bdBtn.getAttribute('data-cand');
          const job = bdBtn.getAttribute('data-job');
          const row = document.getElementById(`bd-${cand}-${job}`);
          if(!row) return;
          const shown = row.style.display !== 'none';
          if(shown){ row.style.display='none'; return; }
          row.style.display='table-row';
          const slot = row.querySelector('td'); if(!slot) return;
          slot.innerHTML = '<div class="empty-state">טוען...</div>';
          try{ const d = await fetchBreakdown(cand, job); slot.innerHTML = renderBreakdownHtml(d); }
          catch(e){ slot.innerHTML = '<div class="empty-state">שגיאה בטעינת הפירוט</div>'; }
        }
      });
      tb._bdBound = true;
    }
    const parts = [];
    if(f.titleContains) parts.push(`כותרת מכילה "${f.titleContains}"`);
    if(f.city) parts.push(`עיר: ${f.city}`);
  if(Array.isArray(f.cities) && f.cities.length) parts.push(`ערים: ${f.cities.join(', ')}`);
    if(f.scoreMin!=null) parts.push(`ציון ≥ ${(Number(f.scoreMin)*100).toFixed(0)}%`);
    if(f.scoreMax!=null) parts.push(`ציון ≤ ${(Number(f.scoreMax)*100).toFixed(0)}%`);
    const sortLabel = matchesState.sort?.by==='score' ? (matchesState.sort?.dir==='asc'?'ציון (עולה)':'ציון (יורד)') : matchesState.sort?.by;
    const pageInfo = `עמוד ${matchesState.page} · ${rows.length} רשומות`;
    const tuneBits = [
      `K=${matchesState.k}`,
      matchesState.cityFilter? 'קרבה: פעיל' : 'קרבה: כבוי',
      `Cache: ${matchesState.cacheStrategy}${Number.isFinite(Number(matchesState.cacheMaxAge))? ' @'+matchesState.cacheMaxAge+'s':''}`,
      matchesState.rp_esco? `RP ESCO: ${matchesState.rp_esco}`:'',
  matchesState.fo_esco? `FO ESCO: ${matchesState.fo_esco}`:'',
  `Weights v1`
    ].filter(Boolean).join(' • ');
    meta.textContent = `${pageInfo}${parts.length? ' • ' + parts.join(' • ') : ''} • מיון: ${sortLabel} • ${tuneBits}`;
  }
  const matchesRefreshBtn = document.getElementById('matchesRefresh');
  if(matchesRefreshBtn) matchesRefreshBtn.onclick = refreshMatches;
  const matchesUndoBtn = document.getElementById('matchesUndo');
  if(matchesUndoBtn) matchesUndoBtn.onclick = undo;
  const matchesRedoBtn = document.getElementById('matchesRedo');
  if(matchesRedoBtn) matchesRedoBtn.onclick = redo;

  // Render filter chips with remove actions
  function renderFilterChips(){
    const el = document.getElementById('matchesChips');
    if(!el) return;
    const f = matchesState.filters || {};
    const chips = [];
    if(f.titleContains) chips.push({type:'titleContains', label:`כותרת: "${f.titleContains}"`});
    if(f.candidateId) chips.push({type:'candidateId', label:`מועמד: ${f.candidateId}`});
    if(f.city) chips.push({type:'city', label:`עיר: ${f.city}`});
    if(Array.isArray(f.cities)) f.cities.forEach((c, idx)=> chips.push({type:'cities', idx, label:`עיר: ${c}`}));
    if(f.scoreMin!=null) chips.push({type:'scoreMin', label:`ציון ≥ ${(Number(f.scoreMin)*100).toFixed(0)}%`});
    if(f.scoreMax!=null) chips.push({type:'scoreMax', label:`ציון ≤ ${(Number(f.scoreMax)*100).toFixed(0)}%`});
    el.innerHTML = chips.map((c,i)=>`<span class="chip" data-type="${c.type}" data-idx="${c.idx??''}">${c.label} <a href="#" data-remove="${i}" style="color:#94a3b8;text-decoration:none;margin-inline-start:6px">×</a></span>`).join(' ');
    if(!el._bound){
      el.addEventListener('click', (ev)=>{
        const a = ev.target.closest('a[data-remove]'); if(!a) return;
        ev.preventDefault();
        const span = a.closest('.chip'); if(!span) return;
        const type = span.getAttribute('data-type');
        const idxStr = span.getAttribute('data-idx');
        pushHistory();
        const f = matchesState.filters;
        if(type==='titleContains') f.titleContains='';
        else if(type==='candidateId') f.candidateId='';
        else if(type==='city') f.city='';
        else if(type==='cities'){
          const idx = Number(idxStr);
          if(Array.isArray(f.cities) && Number.isInteger(idx)) f.cities.splice(idx,1);
        }
        else if(type==='scoreMin') f.scoreMin=null;
        else if(type==='scoreMax') f.scoreMax=null;
        matchesState.page=1;
        renderFilterChips();
        refreshMatches();
      });
      el._bound = true;
    }
  }

  // Clear filters button wiring
  const matchesClearBtn = document.getElementById('matchesClear');
  if(matchesClearBtn){
    matchesClearBtn.onclick = ()=>{
      pushHistory();
      matchesState.page=1;
      matchesState.filters = { titleContains:'', candidateId:'', city:'', cities:[], scoreMin:null, scoreMax:null };
      matchesState.sort = { by:'score', dir:'desc' };
  // Keep tuning but refresh
      const inp=document.getElementById('matchesLimit'); if(inp) inp.value=String(matchesState.limit||50);
      renderFilterChips();
      refreshMatches();
    };
  }

  // Simple chat client for matches analytics
  function pushChat(role, text){
    const log = document.getElementById('chatLog');
    const div = document.createElement('div');
    div.className = `chat-msg ${role}`;
    div.textContent = text;
    log.appendChild(div);
    log.scrollTop = log.scrollHeight;
    return div;
  }

  function canonicalCity(s){ if(!s) return ''; return String(s).trim().toLowerCase().replace(/\s+/g,'_'); }
  function normScore(v){ if(v===null||v===undefined||v==='') return null; let x=Number(v); if(!Number.isFinite(x)) return null; if(x>1) x=x/100; if(x<0) x=0; if(x>1) x=1; return Number(x.toFixed(4)); }

  // ===== Matches by ID (Candidate or Job) =====
  const breakdownCache = Object.create(null);
  function cacheKey(candId, jobId){ return `${candId}__${jobId}`; }
  function checkMark(ok){ return ok ? '✅' : '✖️'; }
  function pct(a,b){ if(!b) return '0%'; return `${Math.round((a/b)*100)}%`; }
  function renderBreakdownHtml(d){
    if(!d) return '<div class="empty-state">אין פירוט זמין</div>';
    const req = d.requirements || {};
    const must = Array.isArray(req.must)? req.must : [];
    const needed = Array.isArray(req.needed)? req.needed : [];
    const fitMust = must.filter(x=>x && x.has).length;
    const fitNeeded = needed.filter(x=>x && x.has).length;
    const features = d.features || d; // fallback to top-level fields if server is older
    const weights = normalizeWeights(d.weights || matchesState.weights || {});
    const agg = d.aggregation || {};
    const gates = Array.isArray(agg.gates_applied)? agg.gates_applied : [];
    const cityGate = d.rules?.city_filter_applied ? 'סינון עיר פעיל' : 'סינון עיר כבוי';
    const titleSim = features.title_similarity ?? d.title_similarity;
    // Prefer raw similarity for display when weight is zero (so users still see real similarity)
    const semSim = (weights.semantic===0 && (features.semantic_similarity_raw ?? d.semantic_similarity_raw) != null)
      ? (features.semantic_similarity_raw ?? d.semantic_similarity_raw)
      : (features.semantic_similarity ?? d.semantic_similarity);
    const embSim = (weights.embedding===0 && (features.embedding_similarity_raw ?? d.embedding_similarity_raw) != null)
      ? (features.embedding_similarity_raw ?? d.embedding_similarity_raw)
      : (features.embedding_similarity ?? d.embedding_similarity);
    const skillsScore = features.weighted_skill_score ?? d.weighted_skill_score;
    const distScore = features.distance_score ?? (Number.isFinite(features.distance_km)? Math.max(0, Math.min(1, 1/(1+(features.distance_km/10)))) : undefined);
    const contrib = agg.contributions || {
      title: (weights.title||0) * (clamp01(titleSim)),
      semantic: (weights.semantic||0) * (clamp01(semSim)),
      embedding: (weights.embedding||0) * (clamp01(embSim)),
      skills: (weights.skills||0) * (clamp01(skillsScore)),
      distance: (weights.distance||0) * (clamp01(distScore)),
    };
    const total = agg.normalized_total ?? agg.pre_normalized_total ?? Object.values(contrib).reduce((a,b)=>a+(Number(b)||0),0);
    function tip(i){
      const reason = (i && i.match_reason) ? String(i.match_reason) : (i && i.has ? 'direct' : 'missing');
      const matched = (i && (i.matched_label || i.matched_candidate_skill)) ? String(i.matched_label || i.matched_candidate_skill) : '';
      if(i && i.has){ return `נמצא (${reason}${matched?`: ${escapeHtml(matched)}`:''})`; }
      return 'חסר';
    }
    const head = `
      <div class="grid-explain cols-2" style="margin-bottom:6px">
        <div>
          ${kv('ציון כולל', pct100(total))}
          <div class="muted" style="font-size:12px">${cityGate}${gates.length? ' • Gates: '+gates.map(escapeHtml).join(', '):''}</div>
        </div>
        <div class="grid-explain">
          ${kv('חובה', `${fitMust}/${must.length} (${pct(fitMust, must.length)})`)}
          ${kv('יתרון', `${fitNeeded}/${needed.length} (${pct(fitNeeded, needed.length)})`)}
        </div>
      </div>`;
    const featHtml = `
      <div class="grid-explain">
        <div>${kv('דמיון כותרת', pct100(titleSim))}${barHtml(titleSim)}</div>
        <div>${kv('דמיון סמנטי', pct100(semSim))}${barHtml(semSim)}</div>
        <div>${kv('דמיון embedding', pct100(embSim))}${barHtml(embSim)}</div>
        <div>${kv('מיומנויות', pct100(skillsScore))}${barHtml(skillsScore)}</div>
        <div>${kv('מרחק', pct100(distScore))}${barHtml(distScore)}</div>
      </div>`;
    const weightsHtml = `
      <div class="grid-explain cols-2" style="margin-top:8px">
        <div class="grid-explain">
          ${kv('w(title)', (weights.title*100).toFixed(0)+'%')}
          ${kv('w(semantic)', (weights.semantic*100).toFixed(0)+'%')}
          ${kv('w(embedding)', (weights.embedding*100).toFixed(0)+'%')}
          ${kv('w(skills)', (weights.skills*100).toFixed(0)+'%')}
          ${kv('w(distance)', (weights.distance*100).toFixed(0)+'%')}
        </div>
        <div>
          <div class="muted" style="font-size:12px">תרומות: weight × feature</div>
          <table style="width:100%;border-collapse:collapse">
            <thead><tr><th style="text-align:right">רכיב</th><th style="text-align:right">תרומה</th></tr></thead>
            <tbody>
              ${['title','semantic','embedding','skills','distance'].map(k=>`<tr><td style="border-bottom:1px solid #1f2937;padding:4px">${k}</td><td style="border-bottom:1px solid #1f2937;padding:4px">${fmtNum(contrib[k],3)}</td></tr>`).join('')}
              <tr><td style="padding:4px"><strong>סה"כ</strong></td><td style="padding:4px"><strong>${fmtNum(total,3)}</strong></td></tr>
            </tbody>
          </table>
        </div>
      </div>`;
    const reqHtml = [
      must.length ? `<div style="margin:10px 0"><div style="font-weight:600;color:#a5b4fc;margin-bottom:4px">חובה</div><div class="chips">${must.map(i=>`<span class="chip" title="${tip(i)}">${checkMark(!!i.has)} ${escapeHtml(i.label||i.name||'')}</span>`).join(' ')}</div></div>` : '',
      needed.length ? `<div style="margin:10px 0"><div style="font-weight:600;color:#a5b4fc;margin-bottom:4px">יתרון</div><div class="chips">${needed.map(i=>`<span class="chip" title="${tip(i)}">${checkMark(!!i.has)} ${escapeHtml(i.label||i.name||'')}</span>`).join(' ')}</div></div>` : ''
    ].join('');
    const rawBtnId = `raw_${Math.random().toString(36).slice(2)}`;
    const rawHtml = `
      <div style="margin-top:8px">
        <button class="btn-small" id="${rawBtnId}">הצג JSON</button>
        <div id="${rawBtnId}_slot" style="display:none;margin-top:6px">${asMonospace(d)}</div>
      </div>`;
    setTimeout(()=>{
      const btn=document.getElementById(rawBtnId); const slot=document.getElementById(`${rawBtnId}_slot`);
      if(btn && slot && !btn._bound){ btn._bound=true; btn.addEventListener('click', ()=>{ slot.style.display = (slot.style.display==='none'||!slot.style.display)?'block':'none'; }); }
    },0);
    return `<div class="explain-card">${head}${featHtml}${weightsHtml}${reqHtml}${rawHtml}</div>`;
  }
  async function fetchBreakdown(candId, jobId){
    const key = cacheKey(candId, jobId);
    if(breakdownCache[key]) return breakdownCache[key];
    const bUrl = `${API}/match/breakdown/${encodeURIComponent(candId)}/${encodeURIComponent(jobId)}`;
    const eUrl = `${API}/match/explain/${encodeURIComponent(candId)}/${encodeURIComponent(jobId)}`;
    // Fetch breakdown first (requirements), then best-effort enrich with explain
    const r1 = await apiFetch(bUrl, { headers: hdrs() });
    if(!r1.ok) throw new Error(`HTTP ${r1.status}`);
    const base = await r1.json();
    try{
      const r2 = await apiFetch(eUrl, { headers: hdrs() });
      if(r2.ok){
        const ex = await r2.json();
        const merged = { ...base, ...ex, features: {
          title_similarity: ex.title_similarity,
          semantic_similarity: ex.semantic_similarity,
          embedding_similarity: ex.embedding_similarity,
          // raw, weight-independent values (may be identical if weights > 0)
          semantic_similarity_raw: ex.semantic_similarity_raw,
          embedding_similarity_raw: ex.embedding_similarity_raw,
          weighted_skill_score: ex.weighted_skill_score,
          distance_km: ex.distance_km,
          distance_score: ex.distance_score
        }, weights: ex.weights || base.weights };
        breakdownCache[key] = merged; return merged;
      }
    }catch(_e){ /* non-fatal; fall back */ }
    breakdownCache[key] = base; return base;
  }
  function isObjectId(s){ return /^[0-9a-f]{24}$/i.test(String(s||'').trim()); }
  let searchAbort;
  function setSearchBusy(b){
    const btn = document.getElementById('searchMatches'); if(btn) btn.disabled = b || !isObjectId(document.getElementById('searchId')?.value);
    const id = document.getElementById('searchId'); if(id) id.disabled = !!b;
    const k = document.getElementById('searchK'); if(k) k.disabled = !!b;
    const cf = document.getElementById('searchCityFilter'); if(cf) cf.disabled = !!b;
    document.querySelectorAll('input[name="searchType"]').forEach(el=> el.disabled = !!b);
  }
  function updateSearchValidity(){
    const idv = document.getElementById('searchId')?.value || '';
    const err = document.getElementById('searchError');
    const btn = document.getElementById('searchMatches');
    if(!idv.trim()){
      if(err) err.textContent = '';
      if(btn) btn.disabled = true;
      return;
    }
    if(!isObjectId(idv)){
      if(err) err.textContent = 'המזהה אינו בפורמט תקין (נדרש 24 תווים הקסדצימליים)';
      if(btn) btn.disabled = true;
    } else {
      if(err) err.textContent = '';
      if(btn) btn.disabled = false;
    }
  }
  async function searchMatchesById(){
    const type = document.getElementById('searchTypeJob')?.checked ? 'job' : 'candidate';
    const id = (document.getElementById('searchId')?.value||'').trim();
    let k = Number(document.getElementById('searchK')?.value||5); if(!Number.isFinite(k)) k=5; k = Math.max(1, Math.min(20, Math.floor(k)));
    const cityFilter = !!document.getElementById('searchCityFilter')?.checked;
    const out = document.getElementById('searchResults'); if(out){ out.style.display='block'; out.innerHTML = '<div class="empty-state loading">טוען התאמות...</div>'; }
    if(searchAbort){ try{ searchAbort.abort(); }catch{} }
    searchAbort = new AbortController();
    setSearchBusy(true);
    try{
      let url;
      const cacheStrategy = 'hybrid';
      const cacheMaxAge = '86400'; // 24h
      if(type==='candidate'){
        url = new URL(`${API}/match/candidate/${encodeURIComponent(id)}`);
        url.searchParams.set('k', String(k));
        url.searchParams.set('city_filter', String(cityFilter));
        url.searchParams.set('strategy', cacheStrategy);
        url.searchParams.set('max_age', cacheMaxAge);
      } else {
        url = new URL(`${API}/match/job/${encodeURIComponent(id)}`);
        url.searchParams.set('k', String(k));
        url.searchParams.set('city_filter', String(cityFilter));
        url.searchParams.set('strategy', cacheStrategy);
        url.searchParams.set('max_age', cacheMaxAge);
      }
      const r = await apiFetch(url, { headers: hdrs(), signal: searchAbort.signal });
      if(!r.ok){
        const msg = r.status===401? 'לא מורשה' : r.status===404? 'לא נמצא' : r.status===429? 'מוגבלות קצב' : 'שגיאה';
        if(out) out.innerHTML = `<div class="empty-state">טעינת התאמות נכשלה (${msg}).</div>`;
        return;
      }
  const j = await r.json();
  const list = Array.isArray(j.matches) ? j.matches : [];
  renderSearchResults(type, id, list, j.cached===true);
    }catch(e){ if(e?.name==='AbortError') return; const out = document.getElementById('searchResults'); if(out) out.innerHTML = '<div class="empty-state">שגיאת רשת</div>'; }
    finally{ setSearchBusy(false); }
  }
  function renderSearchResults(type, id, list, cached){
    const out = document.getElementById('searchResults'); if(!out) return;
    if(!list.length){ out.innerHTML = '<div class="empty-state">לא נמצאו התאמות</div>'; return; }
    if(type==='candidate'){
      const rows = list.map(m=>{
        const score = Math.round(((m.score||0)*100));
        const badge = `<span class="badge ${score>=70?'success':score>=40?'warning':'neutral'}">${score}%</span>`;
        const city = (m.city||'');
        const main = `<tr>
          <td style="direction:ltr">${m.job_id||''}</td>
          <td>${m.title||''}</td>
          <td>${city}</td>
          <td>${badge}</td>
          <td>
            <button class="btn-small" onclick="showJobDetails('${m.job_id||''}')">פרטים</button>
            <button class="btn-small" data-bd="1" data-cand="${id}" data-job="${m.job_id||''}">פירוט התאמה</button>
          </td>
        </tr>`;
        const exp = `<tr class="bd-row" id="bd-${id}-${m.job_id||''}" style="display:none"><td colspan="5"><div class="empty-state">טוען...</div></td></tr>`;
        return main + exp;
      }).join('');
      out.innerHTML = `
        <div class="muted" style="margin-bottom:8px">תוצאות עבור מועמד ${id} (${list.length} התאמות) ${cached?'<span class="badge neutral">ממטמון</span>':''}</div>
        <div style="overflow:auto;max-height:50vh">
          <table>
            <thead><tr><th>משרה</th><th>כותרת</th><th>עיר</th><th>ציון</th><th>פעולות</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        </div>`;
      // Delegate clicks for breakdown toggles
      if(!out._bdBound){
        out.addEventListener('click', async (ev)=>{
          const btn = ev.target.closest('button[data-bd]'); if(!btn) return;
          const cand = btn.getAttribute('data-cand');
          const job = btn.getAttribute('data-job');
          const row = document.getElementById(`bd-${cand}-${job}`);
          if(!row) return;
          const shown = row.style.display !== 'none';
          if(shown){ row.style.display='none'; return; }
          row.style.display='table-row';
          const slot = row.querySelector('td'); if(!slot) return;
          slot.innerHTML = '<div class="empty-state">טוען...</div>';
          try{ const d = await fetchBreakdown(cand, job); slot.innerHTML = renderBreakdownHtml(d); }
          catch(e){ slot.innerHTML = '<div class="empty-state">שגיאה בטעינת הפירוט</div>'; }
        });
        out._bdBound = true;
      }
    } else {
      const rows = list.map(m=>{
        const score = Math.round(((m.score||0)*100));
        const badge = `<span class="badge ${score>=70?'success':score>=40?'warning':'neutral'}">${score}%</span>`;
        const main = `<tr>
          <td style="direction:ltr">${m.candidate_id||''}</td>
          <td>${m.full_name||m.title||''}</td>
          <td>${badge}</td>
          <td>
            <button class="btn-small" onclick="showCandidateDetails('${m.candidate_id||''}')">פרטים</button>
            <button class="btn-small" data-bd="1" data-cand="${m.candidate_id||''}" data-job="${id}">פירוט התאמה</button>
          </td>
        </tr>`;
        const exp = `<tr class="bd-row" id="bd-${m.candidate_id||''}-${id}" style="display:none"><td colspan="4"><div class="empty-state">טוען...</div></td></tr>`;
        return main + exp;
      }).join('');
      out.innerHTML = `
        <div class="muted" style="margin-bottom:8px">תוצאות עבור משרה ${id} (${list.length} התאמות)</div>
        <div style="overflow:auto;max-height:50vh">
          <table>
            <thead><tr><th>מועמד</th><th>שם/כותרת</th><th>ציון</th><th>פעולות</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        </div>`;
      if(!out._bdBound){
        out.addEventListener('click', async (ev)=>{
          const btn = ev.target.closest('button[data-bd]'); if(!btn) return;
          const cand = btn.getAttribute('data-cand');
          const job = btn.getAttribute('data-job');
          const row = document.getElementById(`bd-${cand}-${job}`);
          if(!row) return;
          const shown = row.style.display !== 'none';
          if(shown){ row.style.display='none'; return; }
          row.style.display='table-row';
          const slot = row.querySelector('td'); if(!slot) return;
          slot.innerHTML = '<div class="empty-state">טוען...</div>';
          try{ const d = await fetchBreakdown(cand, job); slot.innerHTML = renderBreakdownHtml(d); }
          catch(e){ slot.innerHTML = '<div class="empty-state">שגיאה בטעינת הפירוט</div>'; }
        });
        out._bdBound = true;
      }
    }
  }
  // Wire up inputs
  (function initSearchById(){
    const idEl = document.getElementById('searchId');
    if(!idEl) return; // page without panel
    idEl.addEventListener('input', updateSearchValidity);
    idEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); if(!document.getElementById('searchMatches').disabled) searchMatchesById(); } });
    document.querySelectorAll('input[name="searchType"]').forEach(el=> el.addEventListener('change', ()=>{
      updateSearchValidity();
      const out = document.getElementById('searchResults');
      if(out){ out.style.display='none'; out.innerHTML=''; }
    }));
    const btn = document.getElementById('searchMatches'); if(btn) btn.addEventListener('click', searchMatchesById);
    updateSearchValidity();
  })();

  function applyChatActions(actions){
    if(!Array.isArray(actions)||!actions.length) return false;
    let changed=false;
    pushHistory();
    for(const a of actions){
      if(!validateAction(a)) continue;
      if(a.type==='setFilters'){
        const p=a.payload||{};
        if(p.titleContains!==undefined){ matchesState.filters.titleContains = String(p.titleContains||''); changed=true; }
        if(p.candidateId!==undefined){ matchesState.filters.candidateId = String(p.candidateId||''); changed=true; }
        if(p.city!==undefined){ matchesState.filters.city = canonicalCity(p.city); changed=true; }
        if(p.cities!==undefined && Array.isArray(p.cities)){
          const arr = p.cities.map(c=>canonicalCity(c)).filter(Boolean);
          const set = new Set(arr);
          if(matchesState.filters.city) set.add(matchesState.filters.city);
          matchesState.filters.city = '';
          matchesState.filters.cities = Array.from(set);
          changed=true;
        }
        if(p.scoreMin!==undefined){ matchesState.filters.scoreMin = normScore(p.scoreMin); changed=true; }
        if(p.scoreMax!==undefined){ matchesState.filters.scoreMax = normScore(p.scoreMax); changed=true; }
        matchesState.page = 1;
      } else if(a.type==='setSort'){
        const p=a.payload||{};
        if(p.by) matchesState.sort.by = p.by;
        if(p.dir) matchesState.sort.dir = p.dir;
        changed=true;
      } else if(a.type==='setPage'){
        const p=a.payload||{};
        if(p.page) { matchesState.page = Math.max(1, parseInt(p.page)); changed=true; }
      } else if(a.type==='setK'){
        const p=a.payload||{}; const k = Math.max(1, Math.min(20, parseInt(p.k)));
        if(k && k!==matchesState.k){ matchesState.k = k; changed=true; const el=document.getElementById('mK'); if(el) el.value=String(k); }
      } else if(a.type==='setCityFilter'){
        const p=a.payload||{}; if(typeof p.enabled==='boolean'){ matchesState.cityFilter = p.enabled; changed=true; const el=document.getElementById('mCityFilter'); if(el) el.checked = !!p.enabled; }
      } else if(a.type==='setCache'){
        const p=a.payload||{};
        if(p.strategy && ['off','on','hybrid'].includes(p.strategy)){ matchesState.cacheStrategy = p.strategy; changed=true; const el=document.getElementById('mStrategy'); if(el) el.value=p.strategy; }
        if(p.maxAge!=null && Number.isFinite(Number(p.maxAge))){ const v=Math.max(0, Math.min(604800, Number(p.maxAge))); matchesState.cacheMaxAge=v; changed=true; const el=document.getElementById('mCacheAge'); if(el) el.value=String(v); }
      } else if(a.type==='setESCO'){
        const p=a.payload||{}; if(p.rp!=null){ matchesState.rp_esco = String(p.rp||''); changed=true; const el=document.getElementById('mRpESCO'); if(el) el.value=matchesState.rp_esco; }
        if(p.fo!=null){ matchesState.fo_esco = String(p.fo||''); changed=true; const el=document.getElementById('mFoESCO'); if(el) el.value=matchesState.fo_esco; }
      } else if(a.type==='setWeights'){
        const p=a.payload||{}; const w={...matchesState.weights};
        const clamp=(x)=>{ const v=Number(x); return Number.isFinite(v)? Math.max(0, Math.min(1, v)) : undefined; };
        let touched=false; ['title','semantic','embedding','skills','distance'].forEach(k=>{ const v=clamp(p[k]); if(v!=null){ w[k]=v; touched=true; } });
        if(touched){ matchesState.weights = w; changed=true; renderGlobalExplainer(); }
      } else if(a.type==='setThresholds'){
        const p=a.payload||{}; const t={...matchesState.thresholds};
        const clamp=(x)=>{ if(x==null) return null; const v=Number(x); return Number.isFinite(v)? Math.max(0, Math.min(1, v)) : null; };
        let touched=false;
        if(p.mustMin!=null){ t.mustMin = clamp(p.mustMin); touched=true; }
        if(p.neededMin!=null){ t.neededMin = clamp(p.neededMin); touched=true; }
        if(p.disqualifyBelow!=null){ t.disqualifyBelow = clamp(p.disqualifyBelow); touched=true; }
        if(touched){ matchesState.thresholds=t; changed=true; renderGlobalExplainer(); }
      } else if(a.type==='saveTuning'){
        // Persist locally first
        try{ localStorage.setItem('matchesTuning', JSON.stringify({ k: matchesState.k, cityFilter: matchesState.cityFilter, cacheStrategy: matchesState.cacheStrategy, cacheMaxAge: matchesState.cacheMaxAge, rp_esco: matchesState.rp_esco, fo_esco: matchesState.fo_esco, weights: matchesState.weights, thresholds: matchesState.thresholds })); }catch{}
        // Best-effort server persistence if API key present
        (async()=>{
          if(!hasAuth()) { toast('נשמר מקומית (התחבר לשמירה בשרת)','warn'); return; }
          try{
            const w = normalizeWeights(matchesState.weights||{});
            const payload = {
              skill_weight: w.skills,
              title_weight: w.title,
              semantic_weight: w.semantic,
              embed_weight: w.embedding,
              distance_weight: w.distance
            };
            const r = await apiFetch(`${API}/match/config`, { method:'PUT', headers: { ...hdrs(), 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if(r.ok){ toast('הגדרות נשמרו בשרת','ok'); }
            else { toast('שמירת שרת נכשלה (נשמר מקומית)','warn'); }
          }catch(e){ toast('שמירת שרת נכשלה (נשמר מקומית)','warn'); }
        })();
        changed=false; // saving does not force refresh by itself
      } else if(a.type==='refresh'){
        changed=true;
      }
    }
    if(changed){
      renderFilterChips();
      // Persist tuning and debounce refresh
      try{ localStorage.setItem('matchesTuning', JSON.stringify({ k: matchesState.k, cityFilter: matchesState.cityFilter, cacheStrategy: matchesState.cacheStrategy, cacheMaxAge: matchesState.cacheMaxAge, rp_esco: matchesState.rp_esco, fo_esco: matchesState.fo_esco })); }catch{}
      scheduleRefreshMatches();
    }
    return changed;
  }

  // Initialize controls and wire change listeners
  (function initMatchControls(){
    const k = document.getElementById('mK'); if(k){ k.value = String(matchesState.k||5); k.addEventListener('input', ()=>{ const v = Math.max(1, Math.min(20, parseInt(k.value||5))); if(v!==matchesState.k){ pushHistory(); matchesState.k=v; scheduleRefreshMatches(); } }); }
    const cf = document.getElementById('mCityFilter'); if(cf){ cf.checked = !!matchesState.cityFilter; cf.addEventListener('change', ()=>{ pushHistory(); matchesState.cityFilter = !!cf.checked; scheduleRefreshMatches(); }); }
    const st = document.getElementById('mStrategy'); if(st){ st.value = matchesState.cacheStrategy||'hybrid'; st.addEventListener('change', ()=>{ pushHistory(); matchesState.cacheStrategy = st.value; scheduleRefreshMatches(); }); }
    const age = document.getElementById('mCacheAge'); if(age){ const v=Number(matchesState.cacheMaxAge); if(Number.isFinite(v)) age.value=String(v); age.addEventListener('input', ()=>{ let x = Number(age.value); if(!Number.isFinite(x)) x = 0; x = Math.max(0, Math.min(604800, Math.floor(x))); if(x!==matchesState.cacheMaxAge){ pushHistory(); matchesState.cacheMaxAge = x; scheduleRefreshMatches(); } }); }
    const rp = document.getElementById('mRpESCO'); if(rp){ rp.value = matchesState.rp_esco||''; rp.addEventListener('change', ()=>{ pushHistory(); matchesState.rp_esco = rp.value.trim(); scheduleRefreshMatches(); }); }
    const fo = document.getElementById('mFoESCO'); if(fo){ fo.value = matchesState.fo_esco||''; fo.addEventListener('change', ()=>{ pushHistory(); matchesState.fo_esco = fo.value.trim(); scheduleRefreshMatches(); }); }
  })();

  // Initialize weights/config controls
  (function initWeightsControls(){
    const loadBtn = document.getElementById('weightsLoad');
    const saveBtn = document.getElementById('weightsSave');
    const localBtn = document.getElementById('weightsLocal');
    const normBtn = document.getElementById('weightsNormalize');
    // Restore from localStorage if available
    try{
      const saved = JSON.parse(localStorage.getItem('matchesConfigForm')||'null');
      if(saved && typeof saved==='object') fillWeightsForm(saved);
      else fillWeightsForm({ skills: matchesState.weights.skills, title: matchesState.weights.title, semantic: matchesState.weights.semantic, embedding: matchesState.weights.embedding, distance: matchesState.weights.distance, must: 0.7, needed: 0.3, minSkillFloor: '' });
    }catch{ fillWeightsForm({ skills: matchesState.weights.skills, title: matchesState.weights.title, semantic: matchesState.weights.semantic, embedding: matchesState.weights.embedding, distance: matchesState.weights.distance, must: 0.7, needed: 0.3, minSkillFloor: '' }); }
    if(loadBtn && !loadBtn._bound){ loadBtn._bound=true; loadBtn.addEventListener('click', loadServerConfig); }
    if(saveBtn && !saveBtn._bound){ saveBtn._bound=true; saveBtn.addEventListener('click', saveServerConfig); saveBtn.disabled = !hasAuth(); }
    if(localBtn && !localBtn._bound){ localBtn._bound=true; localBtn.addEventListener('click', applyLocalWeights); }
    if(normBtn && !normBtn._bound){ normBtn._bound=true; normBtn.addEventListener('click', normalizeWeightsForm); }
    // Auto-load from server once when tab opens
    setTimeout(()=>{ loadServerConfig(); }, 50);
  })();

  async function sendChat(){
    if(!hasAuth()) { toast('התחבר תחילה', 'warning'); return; }
    const inp = document.getElementById('chatQ');
    const q = (inp.value||'').trim();
    if(!q) return;
    pushChat('user', q);
    inp.value='';
    const thinking = pushChat('bot','חושב...');
    const tryEndpoints = async ()=>{
      // primary: GPT-structured actions
      try{
        const r = await apiFetch(`${API}/chat/query`, { method:'POST', headers: { ...hdrs(), 'Content-Type':'application/json' }, body: JSON.stringify({ question: q }) });
        if(r.ok){ return await r.json(); }
      }catch(e){}
      // fallback: deterministic matches chat
      try{
        const r2 = await apiFetch(`${API}/chat/matches`, { method:'POST', headers: { ...hdrs(), 'Content-Type':'application/json' }, body: JSON.stringify({ question: q }) });
        if(r2.ok){ return await r2.json(); }
      }catch(e){}
      return { answer: 'לא הצלחתי להבין את הבקשה' };
    };
    try{
      const j = await tryEndpoints();
      let msg = j.answer || j.message || '';
      if(Array.isArray(j.actions) && j.actions.length){
        applyChatActions(j.actions);
        if(!msg) msg = 'מעודכן ✅';
      } else if(!msg){
        msg = 'אין פעולות לביצוע';
      }
      thinking.textContent = msg;
    }catch(e){
      thinking.textContent = 'שגיאה בעיבוד הבקשה';
    }
  }

  const chatSendBtn = document.getElementById('chatSend');
  if(chatSendBtn) chatSendBtn.onclick = sendChat;

  // ===== Copilot: streaming chat client and UI renderer =====
  const COPILOT_STREAM_TIMEOUT_MS = 600000; // 10 minutes per user request
  let copilotAbort;
  // Track the currently active bot bubble during a stream
  let currentCopilotBubble = null; // { bubbleEl, textEl, attachEl, kpiEl }

  function pushCopilot(role, text){
    // Simple user bubble (bot bubbles should use createBotBubble for richer content)
    const log = document.getElementById('copilotLog');
    const div = document.createElement('div');
    div.className = `chat-msg ${role}`;
    div.textContent = text;
    log.appendChild(div);
    log.scrollTop = log.scrollHeight;
    return div;
  }

  function createBotBubble(initialText){
    const log = document.getElementById('copilotLog');
    const bubble = document.createElement('div');
    bubble.className = 'chat-msg bot';
    const textEl = document.createElement('div');
    textEl.className = 'msg-text';
    textEl.textContent = initialText || '';
  // typing indicator (three dots)
  const typingEl = document.createElement('div');
  typingEl.className = 'typing';
  typingEl.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
  typingEl.style.display = 'none';
    const attachEl = document.createElement('div');
    attachEl.className = 'msg-attachments';
    const kpiEl = document.createElement('div');
    kpiEl.className = 'msg-kpis';
    bubble.appendChild(textEl);
  bubble.appendChild(typingEl);
    bubble.appendChild(kpiEl);
    bubble.appendChild(attachEl);
    log.appendChild(bubble);
    log.scrollTop = log.scrollHeight;
  return { bubbleEl: bubble, textEl, attachEl, kpiEl, typingEl };
  }

  function setBotText(botTarget, text){
    try{
      if(botTarget && botTarget.textEl){ botTarget.textEl.textContent = String(text||''); }
      else if(botTarget){ botTarget.textContent = String(text||''); }
  if(botTarget && botTarget.typingEl){ botTarget.typingEl.style.display = 'none'; }
    }catch{}
  }

  function sanitizeRichHtml(html){
    // Strict allowlist: basic tags only; strip scripts/events
    const tpl = document.createElement('template');
    tpl.innerHTML = html || '';
    const allowed = new Set(['B','I','EM','STRONG','U','P','BR','UL','OL','LI','DIV','SPAN','SMALL','CODE','PRE','A','H1','H2','H3','H4','H5','H6']);
    const walker = document.createTreeWalker(tpl.content, NodeFilter.SHOW_ELEMENT, null);
    const toRemove = [];
    while(walker.nextNode()){
      const el = walker.currentNode;
      if(!allowed.has(el.tagName)) { toRemove.push(el); continue; }
      // Remove event handler attributes and forbid javascript: URLs
  for(const attr of Array.from(el.attributes)){
        const n = attr.name.toLowerCase();
        if(n.startsWith('on')) el.removeAttribute(attr.name);
        if(n==='href' || n==='src'){
          const v = String(attr.value||'');
          if(/^\s*javascript:/i.test(v)) el.removeAttribute(attr.name);
        }
        if(n==='style'){ el.removeAttribute('style'); }
      }
      if(el.tagName==='A'){
        el.setAttribute('rel','noopener noreferrer');
        if(!el.getAttribute('target')) el.setAttribute('target','_blank');
      }
    }
    toRemove.forEach(node=> node.replaceWith(document.createTextNode(node.textContent||'')));
    return tpl.innerHTML;
  }

  function renderCopilotTable(component, mount){
    mount = mount || document.getElementById('copilotUi');
    if(!mount) return;
    const { id, columns = [], rows = [], primaryKey } = component;
    const card = document.createElement('div');
    card.className = 'panel';
    const safeCols = columns.filter(c=>c && c.key && c.title);
    const head = safeCols.map(c=>`<th>${escapeHtml(String(c.title))}</th>`).join('');
    // Show up to 10 rows by default with an expander for the rest
    const MAX_ROWS = 10;
    const initialRows = Array.isArray(rows) ? rows.slice(0, MAX_ROWS) : [];
    const moreCount = Math.max(0, (Array.isArray(rows)? rows.length:0) - initialRows.length);
    const bodyHtml = (list)=> list.map(r=>{
      return '<tr>' + safeCols.map(c=>`<td>${escapeHtml(String(r[c.key] ?? ''))}</td>`).join('') + '</tr>';
    }).join('');
  const title = id==='matches' ? 'תצוגת טבלה (התאמות)' : 'תצוגת טבלה';
    card.innerHTML = `
      <h3 style="margin-top:0">${title}</h3>
      <div style="overflow:auto;max-height:50vh">
        <table>
          <thead><tr>${head}</tr></thead>
          <tbody>${bodyHtml(initialRows) || '<tr><td class="muted" colspan="'+Math.max(safeCols.length,1)+'">אין שורות</td></tr>'}</tbody>
        </table>
      </div>
      ${moreCount>0? `<button class="btn small" data-role="expand">הצג עוד (${moreCount})</button>`:''}
    `;
    if(moreCount>0){
      const btn = card.querySelector('button[data-role="expand"]');
      btn.addEventListener('click', ()=>{
        const tb = card.querySelector('tbody');
        try{ tb.innerHTML = bodyHtml(rows); btn.remove(); }catch{}
      });
    }
    mount.appendChild(card);
  }

  function renderCopilotRichText(component, mount){
    const { html = '' } = component;
    if(!mount) return;
    const card = document.createElement('div');
    card.className = 'panel';
    card.innerHTML = `<div class="muted" style="margin-bottom:6px">הסבר</div><div>${sanitizeRichHtml(html)}</div>`;
    mount.appendChild(card);
  }

  // Render a JobDetails card
  function renderCopilotJobDetails(component, mount){
    mount = mount || document.getElementById('copilotUi');
    if(!mount) return;
    const d = (component && component.details) || {};
    const id = String(d.id || component.id || '');
    const title = String(d.title || '');
    const city = String(d.city || '');
    const must = Array.isArray(d.must_have) ? d.must_have : [];
    const nice = Array.isArray(d.nice_to_have) ? d.nice_to_have : [];
    const chips = (arr)=> arr.map(x=>`<span class="chip">${escapeHtml(String(x))}</span>`).join(' ');
    const card = document.createElement('div');
    card.className = 'panel';
    card.innerHTML = `
      <div class="small muted">פירוט משרה</div>
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin:4px 0 8px 0">
        <div>
          <div class="small muted">${escapeHtml(city)}</div>
          <div style="font-weight:600">${escapeHtml(title)}</div>
        </div>
        ${id ? `<div class="small muted" style="direction:ltr">${escapeHtml(id)}</div>` : ''}
      </div>
      ${must.length? `<div style="margin:8px 0"><div class="small muted" style="margin-bottom:4px">חובה</div><div class="chips">${chips(must)}</div></div>`:''}
      ${nice.length? `<div style="margin:8px 0"><div class="small muted" style="margin-bottom:4px">יתרון</div><div class="chips">${chips(nice)}</div></div>`:''}
    `;
    mount.appendChild(card);
  }

  function renderCopilotMetric(component, strip){
    strip = strip || document.getElementById('copilotKpis');
    if(!strip) return;
    const { label, value, tone='info' } = component;
    const span = document.createElement('span');
    const toneClass = tone==='success' ? 'success' : tone==='warn' ? 'warning' : tone==='danger' ? 'warning' : 'neutral';
    span.className = `badge ${toneClass}`;
    span.textContent = `${label}: ${value}`;
    strip.appendChild(span);
  }

  function renderEnvelope(env){
    if(!env || env.type !== 'assistant_ui') return;
    // Run actions first for deterministic state
    try{ if(Array.isArray(env.actions) && env.actions.length){ applyChatActions(env.actions); } }catch(e){}
    const ui = Array.isArray(env.ui) ? env.ui : [];
    // Determine target mounts: prefer current bot bubble, else global panels
    const targets = currentCopilotBubble || { attachEl: document.getElementById('copilotUi'), kpiEl: document.getElementById('copilotKpis') };
    for(const c of ui){
      if(!c || typeof c !== 'object' || !c.kind) continue;
    if(c.kind==='Table') renderCopilotTable(c, targets.attachEl);
      else if(c.kind==='RichText') renderCopilotRichText(c, targets.attachEl);
      else if(c.kind==='JobDetails') renderCopilotJobDetails(c, targets.attachEl);
      else if(c.kind==='Metric') renderCopilotMetric(c, targets.kpiEl);
  else if(c.kind==='DiscussionThread') renderCopilotDiscussion(c, targets.attachEl);
  else if(c.kind==='SkillsBadges') renderCopilotSkillsBadges(c, targets.attachEl);
  else if(c.kind==='MatchBreakdown') renderCopilotMatchBreakdown(c, targets.attachEl);
  else if(c.kind==='MatchList') renderCopilotMatchList(c, targets.attachEl);
  else if(c.kind==='QuickReplies') renderCopilotQuickReplies(c, targets.attachEl);
      // Unknown kinds ignored safely
    }
  }

  function renderCopilotDiscussion(component, mount){
    mount = mount || document.getElementById('copilotUi');
    if(!mount) return;
    const items = Array.isArray(component.items) ? component.items : [];
    const card = document.createElement('div');
    card.className = 'panel';
    const rows = items.map(it=>{
      const actor = escapeHtml(String(it.actor||''));
      const text = escapeHtml(String(it.text||''));
      const ts = Number(it.created_at||0) * 1000;
      let when = '';
      try{ when = new Date(ts).toLocaleString('he-IL'); }catch(e){ when = '' }
      const tags = Array.isArray(it.tags)? it.tags.slice(0,5).map(t=>`<span class="chip">${escapeHtml(String(t))}</span>`).join(' ') : '';
      return `<div class="panel" style="padding:8px;margin:6px 0">
        <div class="small muted">${actor}${when? ' · '+escapeHtml(when): ''}</div>
        <div style="margin:6px 0">${text}</div>
        <div>${tags}</div>
      </div>`;
    }).join('');
    card.innerHTML = `
      <h3 style="margin-top:0">דיונים / הערות</h3>
      <div>${rows || '<div class="empty-state">אין הערות עדיין</div>'}</div>
    `;
    mount.appendChild(card);
  }

  async function sendCopilotChat(){
    if(!hasAuth()) { toast('התחבר תחילה', 'warning'); return; }
    const inp = document.getElementById('copilotQ');
    const q = (inp.value||'').trim();
    if(!q) return;
    const btn = document.getElementById('copilotSend');
    // Do not clear previous UI; keep history in the chat log
    const user = pushCopilot('user', q);
    inp.value='';
  // Create a rich bot bubble and show typing indicator while waiting
  currentCopilotBubble = createBotBubble('');
  try{ if(currentCopilotBubble.typingEl) currentCopilotBubble.typingEl.style.display='inline-flex'; }catch{}
    if(btn) btn.disabled = true; if(inp) inp.disabled = true;
    if(copilotAbort){ try{ copilotAbort.abort(); }catch{} }
    copilotAbort = new AbortController();
    let done = false;
    let timeout = setTimeout(()=>{
      if(done) return; try{ copilotAbort.abort(); }catch{}; setBotText(currentCopilotBubble, 'תם הזמן לביצוע. נסה לנסח מחדש או לצמצם את הבקשה.'); if(btn) btn.disabled=false; if(inp) inp.disabled=false;
    }, COPILOT_STREAM_TIMEOUT_MS);
    try{
      // Try streaming first
      const res = await apiFetch(`${API}/chat/query?stream=1`, {
        method:'POST', headers: { ...hdrs(), 'Content-Type':'application/json' },
        body: JSON.stringify({ question: q, threadId: state.copilotThreadId||null, detailsOnly: true }), signal: copilotAbort.signal
      });
      if(res.ok && res.body){
        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        let sawEvent = false;
        while(true){
          const {value, done:rdone} = await reader.read();
          if(rdone) break;
          buffer += decoder.decode(value, {stream:true});
          let idx;
          while((idx = buffer.indexOf('\n')) >= 0){
            const line = buffer.slice(0, idx).trim();
            buffer = buffer.slice(idx+1);
            if(!line) continue;
            let evt; try{ evt = JSON.parse(line); }catch(e){ continue; }
            sawEvent = true;
            if(evt.type === 'text_delta'){
              try{ if(currentCopilotBubble && currentCopilotBubble.typingEl) currentCopilotBubble.typingEl.style.display='none'; }catch{}
              setBotText(currentCopilotBubble, String(evt.text||''));
            } else if(evt.type === 'assistant_ui'){
              renderEnvelope(evt);
              setBotText(currentCopilotBubble, evt.narration || 'בוצע');
            } else if(evt.type === 'error'){
              setBotText(currentCopilotBubble, `שגיאה: ${evt.detail||'אירעה תקלה'}`);
            } else if(evt.type === 'done'){
              // no-op
            }
          }
        }
        // If server returned a single JSON (non-NDJSON), try to parse leftover buffer
        if(!sawEvent){
          const left = (buffer||'').trim();
          if(left){
            try{
              const j = JSON.parse(left);
              if(Array.isArray(j.actions) && j.actions.length){ try{ applyChatActions(j.actions); }catch(e){} }
              if(j.type === 'assistant_ui'){ renderEnvelope(j); }
              setBotText(currentCopilotBubble, j.answer || j.message || j.narration || 'בוצע');
            }catch(e){ /* ignore */ }
          }
        }
        done = true;
        clearTimeout(timeout);
  try{ if(currentCopilotBubble && currentCopilotBubble.typingEl) currentCopilotBubble.typingEl.style.display='none'; }catch{}
  currentCopilotBubble = null;
        if(btn) btn.disabled=false; if(inp) inp.disabled=false;
        return;
      }
      // Fallback to non-stream JSON
      const r2 = await apiFetch(`${API}/chat/query`, {
        method:'POST', headers: { ...hdrs(), 'Content-Type':'application/json' },
        body: JSON.stringify({ question: q, threadId: state.copilotThreadId||null, detailsOnly: true }), signal: copilotAbort.signal
      });
  if(!r2.ok){ setBotText(currentCopilotBubble, 'שגיאה בתשובת השרת'); return; }
      const j = await r2.json();
      if(Array.isArray(j.actions) && j.actions.length){ try{ applyChatActions(j.actions); }catch(e){} }
      if(j.type === 'assistant_ui'){ renderEnvelope(j); }
  try{ if(currentCopilotBubble && currentCopilotBubble.typingEl) currentCopilotBubble.typingEl.style.display='none'; }catch{}
  setBotText(currentCopilotBubble, j.answer || j.message || j.narration || 'בוצע');
    }catch(e){
      if(e?.name==='AbortError') return;
      setBotText(currentCopilotBubble, 'שגיאה ברשת או בזמן העיבוד');
    } finally {
  done = true; clearTimeout(timeout);
  try{ if(currentCopilotBubble && currentCopilotBubble.typingEl) currentCopilotBubble.typingEl.style.display='none'; }catch{}
  currentCopilotBubble = null;
      if(btn) btn.disabled=false; if(inp) inp.disabled=false;
    }
  }

  function renderCopilotQuickReplies(component, mount){
    mount = mount || document.getElementById('copilotUi');
    if(!mount) return;
    const items = Array.isArray(component.items)? component.items: [];
    if(!items.length) return;
    const card = document.createElement('div');
    card.className = 'panel';
    const btns = items.slice(0,8).map((it,i)=>{
      const label = escapeHtml(String(it.label||it.prompt||''));
      const prompt = String(it.prompt||'');
      return `<button class="secondary" data-prompt="${escapeHtml(prompt)}" style="margin:4px">${label}</button>`;
    }).join('');
    card.innerHTML = `
      <div class="muted small" style="margin-bottom:6px">Suggested follow-ups</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px">${btns}</div>
    `;
    mount.appendChild(card);
    // Bind clicks
    card.querySelectorAll('button[data-prompt]').forEach(btn=>{
      if(btn._bound) return; btn._bound = true;
      btn.addEventListener('click', ()=>{
        const q = String(btn.getAttribute('data-prompt')||'');
        const inp = document.getElementById('copilotQ');
        if(inp) inp.value = q;
        sendCopilotChat();
      });
    });
  }

  function renderCopilotSkillsBadges(component, mount){
    mount = mount || document.getElementById('copilotUi');
    if(!mount) return;
    const must = Array.isArray(component.must)? component.must: [];
    const nice = Array.isArray(component.nice)? component.nice: [];
    const counters = (component.counters && typeof component.counters==='object')? component.counters: {must:{have:0,total:0}, nice:{have:0,total:0}};
    const card = document.createElement('div');
    card.className = 'panel';
    const chipRow = (label, list)=>{
      const chips = list.slice(0,50).map(s=>{
        const name = typeof s==='string'? s: String(s?.name||'');
        const matched = typeof s==='object' ? !!s.matched : undefined;
        const status = matched===true ? '✅' : matched===false ? '✖️' : '';
        return `<span class="chip">${escapeHtml(name)} ${status}</span>`;
      }).join(' ');
      return `<div style="margin:8px 0"><div class="muted small" style="margin-bottom:6px">${escapeHtml(label)}</div><div style="display:flex;flex-wrap:wrap;gap:6px">${chips || '<span class="muted">—</span>'}</div></div>`;
    };
    const mustCnt = counters.must||{have:0,total:0};
    const niceCnt = counters.nice||{have:0,total:0};
    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <div class="muted small">מיומנויות</div>
        <div class="small">חובה ${Number(mustCnt.have)||0}/${Number(mustCnt.total)||0} · יתרון ${Number(niceCnt.have)||0}/${Number(niceCnt.total)||0}</div>
      </div>
      ${chipRow('חובה', must)}
      ${chipRow('יתרון', nice)}
    `;
    mount.appendChild(card);
  }

  function renderCopilotMatchBreakdown(component, mount){
    mount = mount || document.getElementById('copilotUi');
    if(!mount) return;
    const title = String(component.title||'');
    const scorePct = Number(component.scorePct||0);
    const parts = Array.isArray(component.parts)? component.parts: [];
    const counters = (component.counters && typeof component.counters==='object')? component.counters: {must:{have:0,total:0}, nice:{have:0,total:0}};
    const distancePct = component.distancePct!=null? Number(component.distancePct): null;
    const bar = (label, pct)=>{
      const p = Math.max(0, Math.min(100, Number(pct)||0));
      return `<div style="margin:10px 0"><div class="small muted" style="margin-bottom:4px">${escapeHtml(String(label||''))}</div><div class="meter"><span style="width:${p}%"></span></div></div>`;
    };
    const card = document.createElement('div');
    card.className = 'panel';
    const mustCnt = counters.must||{have:0,total:0};
    const niceCnt = counters.nice||{have:0,total:0};
    const partsHtml = parts.slice(0,10).map(p=>bar(p.label, p.pct)).join('');
    const distHtml = distancePct!=null ? bar('מרחק', distancePct) : '';
    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="small muted">${escapeHtml(title||'')}</div>
          <div class="badge neutral">${Math.max(0,Math.min(100,scorePct))}%</div>
        </div>
        <div class="small muted" style="text-align:right">
          <div>חובה ${Number(mustCnt.have)||0}/${Number(mustCnt.total)||0}</div>
          <div>יתרון ${Number(niceCnt.have)||0}/${Number(niceCnt.total)||0}</div>
        </div>
      </div>
      <div style="margin-top:10px">${partsHtml}${distHtml}</div>
    `;
    mount.appendChild(card);
  }

  function renderCopilotMatchList(component, mount){
    mount = mount || document.getElementById('copilotUi');
    if(!mount) return;
    const items = Array.isArray(component.items)? component.items: [];
    const container = document.createElement('div');
    container.className = 'panel';
    container.innerHTML = `<h3 style="margin:0 0 8px">התאמות</h3>`;
    const frag = document.createDocumentFragment();
    items.slice(0, 10).forEach((it, idx)=>{
      const id = String(it.id||`${idx}`);
      const title = String(it.title||'');
      const city = String(it.city||'');
      const score = Math.max(0, Math.min(100, Number(it.scorePct||0)));
      const mustCnt = (it.counters && it.counters.must) ? it.counters.must : {have:0,total:0};
      const niceCnt = (it.counters && it.counters.nice) ? it.counters.nice : {have:0,total:0};
      const card = document.createElement('div');
      card.className = 'panel';
      const detailsId = `ml_${Date.now()}_${idx}`;
      card.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <div>
            <div class="small muted">${escapeHtml(city)}</div>
            <div style="font-weight:600">${escapeHtml(title)}</div>
          </div>
          <div style="text-align:right">
            <div class="badge neutral" title="ציון">${score}%</div>
            <div class="small muted">חובה ${Number(mustCnt.have)||0}/${Number(mustCnt.total)||0} · יתרון ${Number(niceCnt.have)||0}/${Number(niceCnt.total)||0}</div>
          </div>
        </div>
  <div style="margin-top:8px"><button class="secondary" aria-expanded="false" aria-controls="${detailsId}">Show details</button></div>
        <div id="${detailsId}" style="display:none;margin-top:10px"></div>
      `;
      frag.appendChild(card);
      // Bind toggle to render details lazily once
      const btn = card.querySelector('button[aria-controls]');
      const slot = card.querySelector(`#${detailsId}`);
      if(btn && slot && !btn._bound){
        btn._bound = true;
        btn.addEventListener('click', ()=>{
          const expanded = btn.getAttribute('aria-expanded') === 'true';
          if(expanded){ btn.setAttribute('aria-expanded','false'); slot.style.display='none'; return; }
          btn.setAttribute('aria-expanded','true'); slot.style.display='block';
          // Render SkillsBadges and MatchBreakdown using existing helpers
          try{
            renderCopilotSkillsBadges({ kind:'SkillsBadges', must: (Array.isArray(it.must)? it.must: []), nice:(Array.isArray(it.nice)? it.nice: []), counters: it.counters||{} }, slot);
            renderCopilotMatchBreakdown({ kind:'MatchBreakdown', title: it.title||'', scorePct: it.scorePct||0, parts: (Array.isArray(it.parts)? it.parts: []), counters: it.counters||{}, distancePct: it.distancePct }, slot);
          }catch(e){
            slot.innerHTML = '<div class="empty-state">שגיאה בהצגת הפירוט</div>';
          }
        });
      }
    });
    container.appendChild(frag);
    mount.appendChild(container);
  }

  // Wire Copilot send
  (function initCopilot(){
    const btn = document.getElementById('copilotSend');
    const inp = document.getElementById('copilotQ');
    if(btn && !btn._bound){ btn._bound=true; btn.addEventListener('click', sendCopilotChat); }
    if(inp && !inp._bound){ inp._bound=true; inp.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendCopilotChat(); } }); }
  })();

  // Auto-restore session on load and activate last tab
  (async function initSession(){
    if(hasAuth()){
      try{
        if(state.token){
          const me = await apiFetch(`${API}/auth/me`, { headers: { 'Authorization': `Bearer ${state.token}` } });
          if(me.ok){ state.profile = await me.json(); }
        }
      }catch(e){}
      showUser();
  try{ hideHome(); }catch(e){}
  let tab = 'copilot';
  try{
    const fromHash = (location.hash||'').replace(/^#/,'');
    tab = fromHash || localStorage.getItem('activeTab') || 'copilot';
  }catch(e){}
  activate(tab);
  try{ document.body.classList.toggle('copilot-active', tab==='copilot'); }catch(e){}
  try{ renderGlobalExplainer(); }catch(e){}
      try{ await Promise.allSettled([refreshJobs(), refreshCandidates()]); }catch(e){}
      // Bootstrap Copilot thread and load history when Copilot tab is opened first time
      try{
        // get or create thread
        const rt = await apiFetch(`${API}/assistant/thread/current`, { headers: { ...hdrs() } });
        if(rt.ok){ const j = await rt.json(); state.copilotThreadId = j.threadId; }
        // load history
        if(state.copilotThreadId){
          const rh = await apiFetch(`${API}/assistant/history?thread_id=${encodeURIComponent(state.copilotThreadId)}`, { headers: { ...hdrs() } });
          if(rh.ok){
            const h = await rh.json();
            const msgs = Array.isArray(h.messages)? h.messages: [];
            msgs.forEach(m=>{
              if(m.role==='user'){
                pushCopilot('user', String(m.content?.text||''));
              } else if(m.role==='assistant'){
                // If content is assistant_ui envelope, render; else show text
                const env = m.content && m.content.type? m.content: null;
                if(env && env.type==='assistant_ui'){
                  currentCopilotBubble = createBotBubble(env.narration||'בוצע');
                  try{ renderEnvelope(env); }catch(e){}
                  currentCopilotBubble = null;
                } else {
                  createBotBubble(String(m.content?.text||'בוצע'));
                }
              }
            });
          }
        }
      }catch(e){}
    } else {
      showUser();
  try{ showHome(); }catch(e){}
    }
  })();


  // Refresh button for demo data
  const _matchesDemoBtn = document.getElementById('matchesDemo');
  if(_matchesDemoBtn) _matchesDemoBtn.onclick = async () => {
    document.getElementById('matchesMeta').textContent = 'טוען דמו...';
    const tb = document.getElementById('matchesT');
    tb.innerHTML = '';
    try{
      const r = await apiFetch(`${API}/bootstrap`, {method:'POST', headers: hdrs()});
      if(!r.ok){ throw new Error(await r.text()); }
      const j = await r.json();
      const rows = j.results||[];
      if(rows.length===0){
        document.getElementById('matchesMeta').textContent = 'לא נמצאו התאמות';
        return;
      }
      rows.forEach(row=>{
        const top = (row.matches||[]).slice(0,3).map(m=>`${m.title||'משרה'} (${Math.round((m.score||0)*100)}%)`).join(' • ');
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="direction:ltr">${row.candidate_id}</td>
          <td>${row.title||''}</td>
          <td>${(row.matches||[]).length}</td>
          <td>${top}</td>`;
        tb.appendChild(tr);
      });
      document.getElementById('matchesMeta').textContent = `סה"כ ${rows.length} רשומות`;
    }catch(e){
      document.getElementById('matchesMeta').textContent = 'שגיאה בטעינת דמו';
      console.error('Demo load error:', e);
    }
  };

  // Job upload progress reporting
  const _jobsUpload = document.getElementById('jobsUpload');
  if(_jobsUpload) _jobsUpload.onclick = async () => {
    if(!hasAuth()) { alert('התחבר תחילה'); return; }
    const f = document.getElementById('jobsFile').files[0];
    if(!f){ alert('בחר קובץ'); return; }
    
    // Show progress
    const progressEl = document.getElementById('uploadProgress');
    const progressFill = progressEl.querySelector('.progress-fill');
    const progressText = document.getElementById('progressText');
    const reportEl = document.getElementById('jobsReport');
    
    progressEl.style.display = 'block';
    progressFill.style.width = '20%';
    progressText.textContent = 'מעלה קובץ...';
    reportEl.textContent = '';
    
    const fd = new FormData(); fd.append('file', f);
    let r; let j;
    try{
      progressFill.style.width = '50%';
      progressText.textContent = 'מעבד עם AI...';
      
  r = await apiFetch(`${API}/jobs/batch_csv?format=agency_template&upsert=true`, {method:'POST', headers: hdrs(), body: fd});
      
      progressFill.style.width = '80%';
      progressText.textContent = 'מסיים עיבוד...';
    }catch(e){
      progressEl.style.display = 'none';
      toast('שגיאת רשת בעת הייבוא', 'error'); return;
    }
    progressFill.style.width = '100%';
    progressText.textContent = 'הושלם!';
    
    if(!r.ok){ 
      progressEl.style.display = 'none';
      reportEl.textContent = 'כשל בייבוא'; 
      toast('כשל בייבוא', 'error'); 
      return; 
    }
    try{ j = await r.json(); }catch(e){ 
      progressEl.style.display = 'none';
      reportEl.textContent='תקלה בפענוח תשובת השרת'; 
      toast('תקלה בפענוח תשובת השרת', 'error'); 
      return; 
    }
    
    // Hide progress and show results
    setTimeout(() => progressEl.style.display = 'none', 2000);
    
    const s = j.summary || {};
    const basicStats = `ייבוא: ${s.total||0} שורות | נוצרו ${s.created||0}, עודכנו ${s.updated||0}, כפולים ${s.duplicates||0}, שגיאות ${s.errors||0}`;
    
    // Enhanced LLM reporting
    let llmDetails = '';
    if(typeof s.llm_used === 'number' && s.llm_used > 0) {
      const successRate = s.llm_success ? Math.round((s.llm_success / s.llm_used) * 100) : 0;
      llmDetails = `\nAI: ${s.llm_success||0}/${s.llm_used} הצליחו (${successRate}%)`;
    } else if(s.total > 0) {
      llmDetails = '\nAI: לא הופעל';
    }
    
    reportEl.textContent = basicStats + llmDetails;
    if(typeof s.enriched === 'number'){
      const llmPart = (typeof s.llm_used==='number') ? ` • LLM: הופעל על ${s.llm_used||0}, הצליח ב-${s.llm_success||0}` : '';
      toast(`הושלמה העשרה ל-${s.enriched} משרות${llmPart}`, s.errors? 'warn':'ok');
    }
    await refreshJobs();
  };

  // Job single create
  const _jobCreate = document.getElementById('jobCreate');
  if(_jobCreate) _jobCreate.onclick = async () => {
    if(!hasAuth()) { alert('התחבר תחילה'); return; }
    const payload = {
      external_job_id: document.getElementById('jobExt').value.trim(),
      title: document.getElementById('jobTitle').value.trim(),
      city: document.getElementById('jobCity').value.trim(),
      must_have: document.getElementById('jobMust').value.split(/[\n,;]/).map(s=>s.trim()).filter(Boolean),
      nice_to_have: document.getElementById('jobNice').value.split(/[\n,;]/).map(s=>s.trim()).filter(Boolean),
      description: document.getElementById('jobDesc').value,
      agency_email: document.getElementById('jobEmail').value.trim()
    };
    const h = document.getElementById('jobCreateHint'); h.textContent='';
    try{
  const r = await apiFetch(`${API}/jobs`, {method:'POST', headers: {'Content-Type':'application/json', ...hdrs()}, body: JSON.stringify(payload)});
      if(!r.ok){ h.textContent='שגיאה'; return; }
      const j = await r.json(); h.textContent = `נוצר (${j.job_id})`;
      await refreshJobs();
    }catch(e){ h.textContent='שגיאה'; }
  };

  // Candidates upload
  const _candUpload = document.getElementById('candUpload');
  if(_candUpload) _candUpload.onclick = async () => {
    if(!hasAuth()) { alert('התחבר תחילה'); return; }
    const files = document.getElementById('candFiles').files;
    if(!files || !files.length){ alert('בחר קבצים'); return; }

    // If a CSV is present, preview mapping before upload
    const firstCsv = Array.from(files).find(f => /\.csv$/i.test(f.name));
    if(firstCsv){
      try{
        const { headers, rows } = await readCsvHead(firstCsv, 20);
        if(headers && headers.length){
          const preview = await requestMappingPreview('candidate', headers, rows.slice(0, 5));
          showMappingModal({ preview, onApprove: async () => {
            await uploadCandidateFiles(files);
          }});
          return; // wait for user approval
        }
      }catch(e){ console.warn('CSV preview failed, falling back to direct upload', e); }
    }
    // No CSV or preview failed -> direct upload
    await uploadCandidateFiles(files);
  };

  async function uploadCandidateFiles(files){
    const fd = new FormData(); Array.from(files).forEach(f=>fd.append('files', f));
    const el = document.getElementById('candReport');
    try{
      const r = await apiFetch(`${API}/tenant/candidates/upload`, {method:'POST', headers: hdrs(), body: fd});
      if(!r.ok){ el.textContent = 'כשל בהעלאה'; return; }
      const j = await r.json(); el.textContent = `הועלו ${j.count} קבצים`;
      await refreshCandidates();
    }catch(e){ el.textContent = 'כשל בהעלאה'; }
  }

  // Minimal CSV head reader (handles quoted commas). Reads small slice for preview.
  async function readCsvHead(file, maxRows=20){
    const blob = file.slice(0, Math.min(file.size, 256 * 1024)); // 256KB
    const text = await blob.text();
    const lines = text.split(/\r?\n/).filter(l=>l.trim().length>0);
    if(lines.length === 0) return { headers: [], rows: [] };
    const headers = parseCsvLine(lines[0]);
    const rows = [];
    for(let i=1; i<Math.min(lines.length, maxRows+1); i++){
      rows.push(parseCsvLine(lines[i]));
    }
    return { headers, rows };
  }

  function parseCsvLine(line){
    const out = [];
    let cur = '';
    let inQuotes = false;
    for(let i=0;i<line.length;i++){
      const ch = line[i];
      if(inQuotes){
        if(ch === '"'){
          if(i+1 < line.length && line[i+1] === '"'){ cur += '"'; i++; }
          else { inQuotes = false; }
        } else { cur += ch; }
      } else {
        if(ch === ','){ out.push(cur); cur=''; }
        else if(ch === '"'){ inQuotes = true; }
        else { cur += ch; }
      }
    }
    out.push(cur);
    return out.map(s=>s.trim());
  }

  async function requestMappingPreview(kind, headers, sampleRows){
    const r = await apiFetch(`${API}/mapping/preview`, {
      method: 'POST', headers: { ...hdrs(), 'Content-Type': 'application/json' },
      body: JSON.stringify({ kind, headers, sample_rows: sampleRows })
    });
    if(!r.ok){ throw new Error('preview_failed'); }
    return r.json();
  }

  function showMappingModal({ preview, onApprove }){
    const modal = document.getElementById('mappingModal');
    const content = document.getElementById('mappingModalContent');
    const data = preview;

    const cov = data.coverage || {mapped:0,total:0,percent:0};
    const warns = data.warnings || [];
    const proposed = data.proposed || {};
    const auth = data.authoritative || {};

    const rows = Object.keys(proposed).map(h=>{
      const canon = proposed[h];
      const isAuthName = auth.full_name && auth.full_name === h;
      const isAuthCity = auth.city && auth.city === h;
      return `<tr><td>${escapeHtml(h)}</td><td>${escapeHtml(canon)}</td><td>${isAuthName?'<span class="badge success">שם מועמד</span>':''} ${isAuthCity?'<span class="badge success">עיר</span>':''}</td></tr>`
    }).join('');

    const sample = (data.sample_preview||[]).map(r=>{
      const after = r.after||{}; const keys = Object.keys(after);
      const cols = keys.slice(0,6).map(k=>`<div><strong>${escapeHtml(k)}:</strong> ${escapeHtml(String(after[k]||''))}</div>`).join('');
      return `<div class="llm-section"><div class="muted">שורה ${r.row_idx}</div>${cols}</div>`;
    }).join('');

    const warningsHtml = warns.length ? `<div class="llm-section" style="border:1px solid #f59e0b"><h4>אזהרות</h4><ul>${warns.map(w=>`<li>${escapeHtml(w)}</li>`).join('')}</ul></div>` : '';

    content.innerHTML = `
      <div class="modal-header">
        <h3>תצוגה מקדימה של מיפוי כותרות</h3>
        <button class="modal-close" onclick="closeMappingModal()">&times;</button>
      </div>
      <div class="llm-section">
        <div>כיסוי מיפוי: ${cov.mapped}/${cov.total} (${cov.percent}%)</div>
        <div class="muted">שם ועיר יילקחו אך ורק מהעמודות המסומנות כסמכותיות</div>
      </div>
      ${warningsHtml}
      <div class="llm-section">
        <h4>מיפוי מוצע</h4>
        <div style="max-height:200px;overflow:auto">
          <table style="width:100%"><thead><tr><th>כותרת בקובץ</th><th>כותרת קנונית</th><th>סטטוס</th></tr></thead><tbody>${rows}</tbody></table>
        </div>
      </div>
      <div class="llm-section">
        <h4>דוגמת נתונים לאחר מיפוי</h4>
        ${sample || '<div class="muted">אין דוגמה זמינה</div>'}
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button onclick="closeMappingModal()">בטל</button>
        <button class="primary" id="mappingApproveBtn">אשר והעלה</button>
      </div>`;

    modal.style.display = 'block';
    const approve = document.getElementById('mappingApproveBtn');
    approve.onclick = async () => {
      closeMappingModal();
      try{ await onApprove?.(); } catch(e){ console.error(e); }
    };
  }

  function closeMappingModal(){
    const modal = document.getElementById('mappingModal');
    modal.style.display = 'none';
  }

  function escapeHtml(s){
    return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
  }

  // Job details modal functionality
  async function showJobDetails(jobId) {
    if(!hasAuth()) return;
    try {
  const r = await apiFetch(`${API}/jobs/${jobId}`, {headers: hdrs()});
      if(!r.ok) { toast('שגיאה בטעינת פרטי המשרה', 'error'); return; }
      const job = await r.json();
      
      const modal = document.getElementById('jobModal');
      const content = document.getElementById('jobModalContent');
      
      // Helper function to format skill lists
      function formatSkills(skills, title) {
        if (!skills || skills.length === 0) return `<p class="muted">אין ${title}</p>`;
        return `
          <div class="llm-skills">
            ${skills.map(skill => {
              const name = skill.name || skill;
              const source = skill._source ? ` (${skill._source})` : '';
              const reason = skill.reason ? ` [${skill.reason}]` : '';
              return `<span class="llm-skill">${name}${source}${reason}</span>`;
            }).join('')}
          </div>`;
      }
      
      // Build comprehensive job information
      let content_html = `
        <div class="modal-header">
          <h3>${job.title || 'משרה ללא כותרת'}</h3>
          <button class="modal-close" onclick="closeJobModal()">&times;</button>
        </div>`;
      
      // Basic Info Section
      content_html += `
        <div class="llm-section">
          <h4>📋 מידע בסיסי</h4>
          <p><strong>מזהה:</strong> ${job.job_id}</p>
          <p><strong>מזהה חיצוני:</strong> ${job.external_job_id || 'לא צוין'}</p>
          <p><strong>עיר:</strong> ${job.city_canonical || 'לא צוינה'}</p>
          <p><strong>אימייל סוכנות:</strong> ${job.agency_email || 'לא צוין'}</p>
        </div>`;
      
      // LLM Processing Status
      const llmUsed = job.llm_used_on_enrich;
      const llmSuccess = job.llm_success_on_enrich;
      let llmStatusIcon = '';
      let llmStatusText = '';
      
      if (llmSuccess) {
        llmStatusIcon = '✅';
        llmStatusText = 'עובד בהצלחה עם בינה מלאכותית';
      } else if (llmUsed) {
        llmStatusIcon = '⚠️';
        llmStatusText = 'ניסיון עיבוד AI שלא הצליח במלואו';
      } else if (llmUsed === false) {
        llmStatusIcon = '🔄';
        llmStatusText = 'עובד ללא בינה מלאכותית';
      } else {
        llmStatusIcon = '○';
        llmStatusText = 'עיבוד בסיסי (לפני הוספת AI)';
      }
      
      content_html += `
        <div class="llm-section">
          <h4>${llmStatusIcon} סטטוס עיבוד AI</h4>
          <p>${llmStatusText}</p>
        </div>`;
      
      // Job Description
      if (job.job_description) {
        content_html += `
          <div class="llm-section">
            <h4>📝 תיאור המשרה</h4>
            <p style="white-space: pre-wrap">${job.job_description}</p>
          </div>`;
      }
      
      // Legacy Job Requirements (from older system)
      if (job.job_requirements && job.job_requirements.length > 0) {
        content_html += `
          <div class="llm-section">
            <h4>📋 דרישות מערכת ישנה (${job.job_requirements.length})</h4>
            <ul>
              ${job.job_requirements.map(req => `<li>${req}</li>`).join('')}
            </ul>
          </div>`;
      }
      
  // AI-Extracted Requirements
  if (job.requirements) {
        const req = job.requirements;
        const mustHave = req.must_have_skills || [];
        const niceToHave = req.nice_to_have_skills || [];
        
        content_html += `
          <div class="llm-section">
            <h4>🎯 דרישות מחולצות ע"י AI</h4>
            <div style="margin-bottom: 12px;">
              <strong>כישורים חובה (${mustHave.length}):</strong>
              ${formatSkills(mustHave, 'כישורים חובה')}
            </div>
            <div>
              <strong>כישורים רצויים (${niceToHave.length}):</strong>
              ${formatSkills(niceToHave, 'כישורים רצויים')}
            </div>
          </div>`;
      }
      
      // Seniority Level
      if (job.seniority) {
        content_html += `
          <div class="llm-section">
            <h4>👔 רמת ותק</h4>
            <p>${job.seniority}</p>
          </div>`;
      }
      
      // Mandatory Requirements
      if (job.mandatory_requirements && job.mandatory_requirements.length > 0) {
        content_html += `
          <div class="llm-section">
            <h4>⚠️ דרישות חובה נוספות (${job.mandatory_requirements.length})</h4>
            <ul>
              ${job.mandatory_requirements.map(req => `<li>${req}</li>`).join('')}
            </ul>
          </div>`;
      }
      
      // Synthetic Skills (AI-generated)
      if (job.synthetic_skills && job.synthetic_skills.length > 0) {
        content_html += `
          <div class="llm-section">
            <h4>🤖 כישורים סינתטיים (${job.synthetic_skills.length})</h4>
            <p class="muted" style="font-size: 12px;">כישורים שנוצרו אוטומטית על בסיס ניתוח התפקיד</p>
            ${formatSkills(job.synthetic_skills, 'כישורים סינתטיים')}
          </div>`;
      }
      
      // Raw JSON Data (for debugging/transparency)
      content_html += `
        <div class="llm-section">
          <h4>🔍 נתונים גולמיים (JSON)</h4>
          <details style="margin-top: 8px;">
            <summary style="cursor: pointer; color: #93c5fd;">הצג JSON מלא</summary>
            <pre style="background: #0a1020; padding: 10px; border-radius: 6px; overflow-x: auto; font-size: 11px; margin-top: 8px;">${JSON.stringify(job, null, 2)}</pre>
          </details>
        </div>`;
      
      content.innerHTML = content_html;
      modal.style.display = 'block';
    } catch(e) {
      toast('שגיאה בטעינת פרטי המשרה', 'error');
      console.error('Job details error:', e);
    }
  }
  
  function closeJobModal() {
    document.getElementById('jobModal').style.display = 'none';
  }
  
  function closeCandidateModal() {
    document.getElementById('candidateModal').style.display = 'none';
  }
  
  function closeMatchesModal() {
    document.getElementById('matchesModal').style.display = 'none';
  }
  
  function closeLetterModal() {
    document.getElementById('letterModal').style.display = 'none';
  }

  // Candidate details modal functionality
  async function showCandidateDetails(candidateId) {
    if(!hasAuth()) return;
    try {
  const r = await apiFetch(`${API}/candidate/${candidateId}`, {headers: hdrs()});
  if(!r.ok) { toast('שגיאה בטעינת פרטי המועמד', 'error'); return; }
  // Backend may return {candidate: {...}}; unwrap defensively
  const data = await r.json();
  const candidate = (data && typeof data === 'object' && data.candidate) ? data.candidate : data;
      
      const modal = document.getElementById('candidateModal');
      const content = document.getElementById('candidateModalContent');
      
      // Helper function to format skills
      function formatSkills(skills, title) {
        if (!skills || skills.length === 0) return `<p class="muted">אין ${title}</p>`;
        return `
          <div class="llm-skills">
            ${skills.map(skill => `<span class="llm-skill">${skill}</span>`).join('')}
          </div>`;
      }
      
      // Build comprehensive candidate information
      let content_html = `
        <div class="modal-header">
          <h3>${candidate.full_name || candidate.title || 'מועמד ללא שם'}</h3>
          <button class="modal-close" onclick="closeCandidateModal()">&times;</button>
        </div>`;
      
      // Basic Info Section
      content_html += `
        <div class="llm-section">
          <h4>👤 מידע בסיסי</h4>
          <p><strong>מזהה:</strong> ${candidate.candidate_id || candidateId}</p>
          <p><strong>שם מלא:</strong> ${candidate.full_name || candidate.title || 'לא צוין'}</p>
          <p><strong>תפקיד:</strong> ${candidate.title || candidate.full_name || 'לא צוין'}</p>
          <p><strong>עיר:</strong> ${candidate.city || candidate.city_canonical || 'לא צוינה'}</p>
          <p><strong>שנות ניסיון:</strong> ${candidate.years_experience || 'לא צוין'}</p>
          <p><strong>Share ID:</strong> ${candidate.share_id || 'לא זמין'}</p>
        </div>`;
      
      // Skills Section
  const skillSet = (candidate.skill_set || candidate.skills || []);
  if (Array.isArray(skillSet) && skillSet.length > 0) {
        content_html += `
          <div class="llm-section">
    <h4>🎯 כישורים (${skillSet.length})</h4>
    ${formatSkills(skillSet, 'כישורים')}
          </div>`;
      }
      
      // Summary Section
      if (candidate.summary) {
        content_html += `
          <div class="llm-section">
            <h4>📝 תקציר</h4>
            <p style="white-space: pre-wrap">${candidate.summary}</p>
          </div>`;
      }
      
      // Tools Section
      if (candidate.tools && candidate.tools.length > 0) {
        content_html += `
          <div class="llm-section">
            <h4>🛠️ כלים וטכנולוגיות (${candidate.tools.length})</h4>
            ${formatSkills(candidate.tools, 'כלים')}
          </div>`;
      }
      
      // Languages Section
      if (candidate.languages && candidate.languages.length > 0) {
        content_html += `
          <div class="llm-section">
            <h4>🌐 שפות (${candidate.languages.length})</h4>
            ${formatSkills(candidate.languages, 'שפות')}
          </div>`;
      }
      
      // Raw JSON Data
      content_html += `
        <div class="llm-section">
          <h4>🔍 נתונים גולמיים (JSON)</h4>
          <details style="margin-top: 8px;">
            <summary style="cursor: pointer; color: #93c5fd;">הצג JSON מלא</summary>
            <pre style="background: #0a1020; padding: 10px; border-radius: 6px; overflow-x: auto; font-size: 11px; margin-top: 8px;">${JSON.stringify(candidate, null, 2)}</pre>
          </details>
        </div>`;
      
      content.innerHTML = content_html;
      modal.style.display = 'block';
    } catch(e) {
      toast('שגיאה בטעינת פרטי המועמד', 'error');
      console.error('Candidate details error:', e);
    }
  }

  // Job matches modal functionality
  async function showJobMatches(candidateId) {
    if(!hasAuth()) return;
    try {
  const r = await apiFetch(`${API}/match/candidate/${candidateId}?k=10`, {headers: hdrs()});
      if(!r.ok) { toast('שגיאה בטעינת התאמות', 'error'); return; }
      const data = await r.json();
      
      const modal = document.getElementById('matchesModal');
      const content = document.getElementById('matchesModalContent');
      
      let content_html = `
        <div class="modal-header">
          <h3>התאמות משרות למועמד</h3>
          <button class="modal-close" onclick="closeMatchesModal()">&times;</button>
        </div>`;
      
      if (!data.matches || data.matches.length === 0) {
        content_html += `
          <div class="llm-section">
            <p class="muted">לא נמצאו התאמות למועמד זה</p>
          </div>`;
      } else {
        content_html += `
          <div class="llm-section">
            <h4>🎯 נמצאו ${data.matches.length} התאמות</h4>
            <p class="muted">ציון התאמה מבוסס על כישורים, מיקום ונתונים נוספים</p>
          </div>`;
        
        data.matches.forEach((match, index) => {
          const score = Math.round((match.score || 0) * 100);
          const skillOverlap = match.skill_overlap || [];
          const distance = match.distance_km ? `${match.distance_km} ק"מ` : 'מרחק לא ידוע';
          
          content_html += `
            <div class="llm-section">
              <h4>${index + 1}. ${match.title || 'משרה ללא כותרת'} - ${score}%</h4>
              <p><strong>מיקום:</strong> ${match.city || 'לא צוין'} (${distance})</p>
              <p><strong>סיבת התאמה:</strong> ${match.reason || 'לא צוין'}</p>
              ${skillOverlap.length > 0 ? `
                <p><strong>כישורים משותפים (${skillOverlap.length}):</strong></p>
                <div class="llm-skills">
                  ${skillOverlap.map(skill => `<span class="llm-skill">${skill}</span>`).join('')}
                </div>
              ` : '<p class="muted">אין כישורים משותפים מזוהים</p>'}
              <div style="margin-top: 8px;">
                <button class="btn-small" onclick="showJobDetails('${match.job_id}')">פרטי משרה</button>
              </div>
            </div>`;
        });
      }
      
      content.innerHTML = content_html;
      modal.style.display = 'block';
    } catch(e) {
      toast('שגיאה בטעינת התאמות', 'error');
      console.error('Job matches error:', e);
    }
  }

  // Personal letter modal functionality
  async function showPersonalLetter(shareId) {
    if(!hasAuth()) return;
    try {
  const r = await apiFetch(`${API}/personal-letter/${shareId}`, {headers: hdrs()});
      if(!r.ok) { 
        if(r.status === 404) {
          toast('לא נמצא מכתב אישי למועמד זה', 'warning');
        } else {
          toast('שגיאה בטעינת מכתב אישי', 'error');
        }
        return; 
      }
  const data = await r.json();
      
      const modal = document.getElementById('letterModal');
      const content = document.getElementById('letterModalContent');
      
      const letter = data.letter || {};
      
      let content_html = `
        <div class="modal-header">
          <h3>מכתב אישי - ${data.candidate_name || 'מועמד'}</h3>
          <button class="modal-close" onclick="closeLetterModal()">&times;</button>
        </div>`;
      
      // Letter content
      content_html += `
        <div class="llm-section">
          <h4>💌 תוכן המכתב</h4>
          <div style="background: #0a1020; padding: 15px; border-radius: 8px; white-space: pre-wrap; line-height: 1.6;">
            ${letter.letter_content || 'אין תוכן מכתב זמין'}
          </div>
        </div>`;
      
      // Key strengths
      if (letter.key_strengths && letter.key_strengths.length > 0) {
        content_html += `
          <div class="llm-section">
            <h4>💪 נקודות חוזק מרכזיות</h4>
            <div class="llm-skills">
              ${letter.key_strengths.map(strength => `<span class="llm-skill">${strength}</span>`).join('')}
            </div>
          </div>`;
      }
      
      // Market positioning
      if (letter.market_positioning) {
        content_html += `
          <div class="llm-section">
            <h4>📈 מיקום בשוק</h4>
            <p>${letter.market_positioning}</p>
          </div>`;
      }
      
      // Confidence boost
      if (letter.confidence_boost) {
        content_html += `
          <div class="llm-section">
            <h4>⚡ הודעת עידוד</h4>
            <p>${letter.confidence_boost}</p>
          </div>`;
      }
      
      // Next steps
      if (letter.next_steps && letter.next_steps.length > 0) {
        content_html += `
          <div class="llm-section">
            <h4>👉 צעדים הבאים</h4>
            <ul>
              ${letter.next_steps.map(step => `<li>${step}</li>`).join('')}
            </ul>
          </div>`;
      }
      
      // Fetch top matches for actions (best-effort)
      let actions_html = '';
      try {
        const matchesR = await apiFetch(`${API}/share/candidate/${shareId}?k=5`, {headers: hdrs()});
        if (matchesR.ok) {
          const matchesData = await matchesR.json();
          const jobs = (matchesData.matches || []).slice(0, 3);
          if (jobs.length > 0) {
            const cards = await Promise.all(jobs.map(async (m) => {
              const jid = m.job_id;
              // tenant-aware job details
              let jdoc = null;
              try {
                const jr = await apiFetch(`${API}/jobs/${jid}`, {headers: hdrs()});
                if (jr.ok) jdoc = await jr.json();
              } catch (e) {}
              const title = jdoc?.title || m.title || 'משרה';
              const city = jdoc?.city_canonical || m.city || '';
              const reqs = (jdoc?.requirements?.must_have_skills || []).map(s=>s.name || s).slice(0,5);
              const reqList = reqs.length ? reqs.join(', ') : (m.job_requirements || []).slice(0,5).join(', ');
              return `
                <div class="llm-section">
                  <h4>${title}</h4>
                  <p class="muted">${city}</p>
                  ${reqList ? `<p><strong>דרישות:</strong> ${reqList}</p>` : ''}
                  <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px;">
                    <button class="btn-small" onclick="showJobDetails('${jid}')">פרטי משרה</button>
                    <button class="btn-small" onclick="confirmApplication('${shareId}','${jid}')">אישור הגשת מועמדות</button>
                  </div>
                  <div style="background:#f0f8ff; padding:8px; border-radius:6px; border:1px solid #b3d9ff;">
                    <p style="margin:0; font-size:13px; color:#0066cc;">
                      📱 <strong>קישור נייד:</strong>
                      <a href="/mobile-job.html?job_id=${jid}&share_id=${shareId}" 
                         target="_blank" 
                         style="color:#0066cc; text-decoration:underline;">
                        צפה במשרה במובייל
                      </a>
                    </p>
                    <p style="margin:4px 0 0; font-size:12px; color:#666;">
                      קישור זה מיועד לשליחה ב-SMS למועמד
                      <button onclick="copyMobileLink('${jid}', '${shareId}')" 
                              style="margin-right:8px; padding:2px 8px; font-size:11px; background:#0066cc; color:white; border:none; border-radius:3px; cursor:pointer;">
                        העתק קישור
                      </button>
                    </p>
                  </div>
                </div>`;
            }));
            actions_html = `
              <div class="llm-section">
                <h4>🧩 משרות מוצעות</h4>
                ${cards.join('')}
              </div>`;
          }
        }
      } catch (e) { console.warn('matches fetch failed', e); }

      // Meta information
      content_html += `
        <div class="llm-section">
          <h4>📊 מידע נוסף</h4>
          <p><strong>מספר מילים:</strong> ${letter.word_count || 'לא זמין'}</p>
          <p><strong>מספר התאמות:</strong> ${data.match_count || 0}</p>
          <p><strong>נוצר מהמטמון:</strong> ${data.cached ? 'כן' : 'לא'}</p>
        </div>`;

      // Actions
      content_html += actions_html;
      
      content.innerHTML = content_html;
      modal.style.display = 'block';
    } catch(e) {
      toast('שגיאה בטעינת מכתב אישי', 'error');
      console.error('Personal letter error:', e);
    }
  }

  // Copy mobile link to clipboard for SMS sending
  function copyMobileLink(jobId, shareId) {
    const baseUrl = window.location.origin;
    const mobileUrl = `${baseUrl}/mobile-job.html?job_id=${jobId}&share_id=${shareId}`;
    
    if (navigator.clipboard) {
      navigator.clipboard.writeText(mobileUrl).then(() => {
        toast('קישור הועתק ללוח! 📱', 'success');
      }).catch(() => {
        toast('שגיאה בהעתקת הקישור', 'error');
      });
    } else {
      // Fallback for older browsers
      const textArea = document.createElement('textarea');
      textArea.value = mobileUrl;
      document.body.appendChild(textArea);
      textArea.select();
      try {
        document.execCommand('copy');
        toast('קישור הועתק ללוח! 📱', 'success');
      } catch (err) {
        toast('שגיאה בהעתקת הקישור', 'error');
      }
      document.body.removeChild(textArea);
    }
  }

  // Confirm application - POST /confirm/apply
  async function confirmApplication(shareId, jobId){
    if(!hasAuth()) return;
    try{
      const r = await apiFetch(`${API}/confirm/apply`, {
        method: 'POST',
        headers: { ...hdrs(), 'Content-Type': 'application/json' },
        body: JSON.stringify({ share_id: shareId, job_id: jobId })
      });
      if(!r.ok){
        const txt = await r.text();
        toast('כשל בשליחת האישור: ' + (txt||r.status), 'error');
        return;
      }
      const j = await r.json();
      toast('נשלח מייל אישור ✅', 'ok');
    }catch(e){
      toast('שגיאת רשת בשליחת האישור', 'error');
    }
  }

  // Generate personal letter functionality
  async function generatePersonalLetter(shareId) {
    if(!hasAuth()) return;
    try {
      toast('יוצר מכתב אישי...', 'info');
      
  const r = await apiFetch(`${API}/personal-letter`, {
        method: 'POST',
        headers: {...hdrs(), 'Content-Type': 'application/json'},
        body: JSON.stringify({share_id: shareId, force: true})
      });
      
      if(!r.ok) { 
        const errorData = await r.json().catch(() => ({}));
        const errorMsg = errorData.detail || 'שגיאה ביצירת מכתב אישי';
        toast(errorMsg, 'error'); 
        return; 
      }
      
      const data = await r.json();
      toast('מכתב אישי נוצר בהצלחה!', 'success');
      
      // Show the newly created letter
      showPersonalLetter(shareId);
      
      // Refresh candidates list to update status
      await refreshCandidates();
    } catch(e) {
      toast('שגיאה ביצירת מכתב אישי', 'error');
      console.error('Generate personal letter error:', e);
    }
  }
  
  // (Removed duplicate window.onclick; a unified handler exists at the bottom of the file)
  </script>

    <!-- Job Details Modal -->
  <div id="jobModal" class="modal">
    <div class="modal-content">
      <div id="jobModalContent"></div>
    </div>
  </div>

    <div id="imports" class="panel" style="display:none">
      <h2>ייבוא CSV</h2>
      <div id="importsWrap" style="position:relative">
        <div id="importsFallback" class="hint" style="position:absolute;top:8px;inset-inline:12px;z-index:2">
          טוען דף הייבוא… אם נשאר ריק, <a href="/imports.html" target="_blank" rel="noopener">פתח בחלון חדש</a>
        </div>
        <iframe id="importsFrame" src="/imports.html" onload="(function(){var f=document.getElementById('importsFallback'); if(f) f.style.display='none';})()" style="width:100%;height:80vh;border:0;border-radius:12px;background:#0a1428"></iframe>
      </div>
      <div class="hint">אם אינך רואה מפתח API נטען בפינה בדף המוטמע, התחבר דרך הפורטל והדף ישתמש ב-API Key אוטומטית.</div>
    </div>

  <!-- Candidate Details Modal -->
  <div id="candidateModal" class="modal">
    <div class="modal-content">
      <div id="candidateModalContent"></div>
    </div>
  </div>

  <!-- Job Matches Modal -->
  <div id="matchesModal" class="modal">
    <div class="modal-content">
      <div id="matchesModalContent"></div>
    </div>
  </div>

  <!-- Personal Letter Modal -->
  <div id="letterModal" class="modal">
    <div class="modal-content">
      <div id="letterModalContent"></div>
    </div>
  </div>

  <!-- Mapping Preview Modal -->
  <div id="mappingModal" class="modal">
    <div class="modal-content">
      <div id="mappingModalContent"></div>
    </div>
  </div>

<script>
  // Close modal when clicking outside
  window.onclick = function(event) {
    const jobModal = document.getElementById('jobModal');
    const candidateModal = document.getElementById('candidateModal');
    const matchesModal = document.getElementById('matchesModal');
    const letterModal = document.getElementById('letterModal');
  const mappingModal = document.getElementById('mappingModal');
    
    if (event.target == jobModal) {
      jobModal.style.display = 'none';
    }
    if (event.target == candidateModal) {
      candidateModal.style.display = 'none';
    }
    if (event.target == matchesModal) {
      matchesModal.style.display = 'none';
    }
    if (event.target == letterModal) {
      letterModal.style.display = 'none';
    }
    if (event.target == mappingModal) {
      mappingModal.style.display = 'none';
    }
  }
</script>

  <footer class="site-footer" role="contentinfo" aria-label="Site footer">
    <div class="inner">
      <div>© <span aria-label="year">2025</span> Recruiter Copilot</div>
      <nav aria-label="Footer navigation">
        <a href="/privacy.html" aria-label="Privacy Policy">Privacy</a>
        ·
        <a href="/terms.html" aria-label="Terms of Service">Terms</a>
        ·
        <a href="/contact.html" aria-label="Contact support">Contact</a>
      </nav>
    </div>
  </footer>

</body>
</html>
